"use client";
import { useState, useEffect, useRef } from "react";

const LOGO_B64 = "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";
const LOGO_URI = "data:image/png;base64," + LOGO_B64;

// ── Colors ──
const O = "#EA580C", OL = "#FFF7ED", OD = "#C2410C";
const D = "#F9FAFB", D2 = "#F3F4F6", D3 = "#FFFFFF", D4 = "#E5E7EB";
const G = "#6B7280", W = "#111827", GR = "#22C55E", RD = "#EF4444", YL = "#F59E0B", BL = "#3B82F6";

// ── Default data ──
const DEFAULT_INVENTORY = [
  { id: "inv1", name: "Fire Alarm Panel (Addressable)", category: "Fire Alarm", unit_cost: 4500, unit: "per panel", description: "Addressable fire alarm control panel, supports up to 250 devices" },
  { id: "inv2", name: "Smoke Detector (Photoelectric)", category: "Fire Alarm", unit_cost: 85, unit: "per device", description: "Photoelectric smoke detector, ceiling mount" },
  { id: "inv3", name: "Pull Station", category: "Fire Alarm", unit_cost: 120, unit: "per device", description: "Manual fire alarm pull station, dual action" },
  { id: "inv4", name: "Horn/Strobe Combo", category: "Fire Alarm", unit_cost: 150, unit: "per device", description: "Wall-mount horn/strobe notification appliance, ADA compliant" },
  { id: "inv5", name: "Sprinkler Head (Pendant)", category: "Sprinkler", unit_cost: 45, unit: "per head", description: "Standard pendant sprinkler head, 155°F rating" },
  { id: "inv6", name: "Sprinkler Head (Sidewall)", category: "Sprinkler", unit_cost: 65, unit: "per head", description: "Sidewall sprinkler head for corridor applications" },
  { id: "inv7", name: "Fire Extinguisher (ABC, 10lb)", category: "Extinguisher", unit_cost: 75, unit: "each", description: "Multi-purpose ABC dry chemical, 10lb capacity" },
  { id: "inv8", name: "Exit Sign (LED, Battery Backup)", category: "Egress", unit_cost: 95, unit: "each", description: "LED exit sign with 90-min battery backup" },
  { id: "inv9", name: "Emergency Light (LED)", category: "Egress", unit_cost: 110, unit: "each", description: "Dual-head LED emergency light, 90-min backup" },
  { id: "inv10", name: "Kitchen Hood Suppression System", category: "Suppression", unit_cost: 8500, unit: "per system", description: "Wet chemical kitchen hood fire suppression, includes installation" },
  { id: "inv11", name: "Fire Door (3hr rated)", category: "Passive", unit_cost: 1800, unit: "per door", description: "3-hour fire rated door assembly with closer and hardware" },
  { id: "inv12", name: "Fire Caulk / Firestop", category: "Passive", unit_cost: 35, unit: "per penetration", description: "Intumescent firestop sealant for wall/floor penetrations" },
  { id: "inv13", name: "Monitoring Service (Annual)", category: "Monitoring", unit_cost: 600, unit: "per year", description: "24/7 UL-listed central station fire alarm monitoring" },
  { id: "inv14", name: "Fire Alarm Inspection (Annual)", category: "Inspection", unit_cost: 450, unit: "per visit", description: "NFPA 72 compliant annual fire alarm inspection and testing" },
  { id: "inv15", name: "Sprinkler Inspection (Annual)", category: "Inspection", unit_cost: 350, unit: "per visit", description: "NFPA 25 compliant annual sprinkler system inspection" },
  // Security Alarm
  { id: "inv16", name: "Intrusion Alarm Panel", category: "Security Alarm", unit_cost: 3200, unit: "per panel", description: "Commercial intrusion alarm control panel, 64-zone expandable" },
  { id: "inv17", name: "Motion Detector (PIR)", category: "Security Alarm", unit_cost: 95, unit: "per device", description: "Passive infrared motion detector, pet-immune, wall/ceiling mount" },
  { id: "inv18", name: "Door/Window Contact Sensor", category: "Security Alarm", unit_cost: 45, unit: "per device", description: "Surface-mount magnetic door/window contact, hardwired" },
  { id: "inv19", name: "Glass Break Detector", category: "Security Alarm", unit_cost: 110, unit: "per device", description: "Acoustic glass break sensor, 25ft range" },
  { id: "inv20", name: "Keypad (Touchscreen)", category: "Security Alarm", unit_cost: 275, unit: "each", description: "Color touchscreen alarm keypad with proximity reader" },
  { id: "inv21", name: "Siren (Interior)", category: "Security Alarm", unit_cost: 65, unit: "each", description: "Interior piezo siren, 110dB output" },
  { id: "inv22", name: "Siren (Exterior Strobe)", category: "Security Alarm", unit_cost: 185, unit: "each", description: "Weatherproof exterior siren with strobe, tamper-proof" },
  { id: "inv23", name: "Security Monitoring (Annual)", category: "Security Alarm", unit_cost: 480, unit: "per year", description: "24/7 UL-listed central station intrusion monitoring" },
  // Cameras
  { id: "inv24", name: "IP Camera (4MP Dome)", category: "Cameras", unit_cost: 320, unit: "each", description: "4MP indoor dome IP camera, IR night vision, PoE" },
  { id: "inv25", name: "IP Camera (4MP Bullet)", category: "Cameras", unit_cost: 350, unit: "each", description: "4MP outdoor bullet IP camera, IP67 weatherproof, IR 100ft" },
  { id: "inv26", name: "IP Camera (4K Turret)", category: "Cameras", unit_cost: 480, unit: "each", description: "8MP 4K turret camera, wide angle, built-in mic, PoE" },
  { id: "inv27", name: "PTZ Camera (4MP)", category: "Cameras", unit_cost: 1200, unit: "each", description: "4MP pan-tilt-zoom camera, 25x optical zoom, auto-tracking" },
  { id: "inv28", name: "NVR (16-Channel)", category: "Cameras", unit_cost: 850, unit: "each", description: "16-channel network video recorder, 4TB HDD, H.265+" },
  { id: "inv29", name: "NVR (32-Channel)", category: "Cameras", unit_cost: 1400, unit: "each", description: "32-channel NVR, 8TB HDD, RAID support, remote viewing" },
  { id: "inv30", name: "Camera License Plate Reader (LPR)", category: "Cameras", unit_cost: 1800, unit: "each", description: "Dedicated LPR camera with analytics, vehicle logging" },
  { id: "inv31", name: "Camera Installation (per camera)", category: "Cameras", unit_cost: 250, unit: "per camera", description: "Professional camera installation, includes cabling up to 200ft, mounting, and configuration" },
  { id: "inv32", name: "Video Monitoring Service (Annual)", category: "Cameras", unit_cost: 720, unit: "per year", description: "Remote video monitoring and verification service, 24/7" },
  // Access Control
  { id: "inv33", name: "Access Control Panel (2-Door)", category: "Access Control", unit_cost: 1100, unit: "per panel", description: "2-door access controller, supports card + PIN + mobile credentials" },
  { id: "inv34", name: "Access Control Panel (4-Door)", category: "Access Control", unit_cost: 1800, unit: "per panel", description: "4-door access controller, TCP/IP, battery backup" },
  { id: "inv35", name: "Card Reader (Proximity)", category: "Access Control", unit_cost: 175, unit: "each", description: "Proximity card/fob reader, Wiegand output, weatherproof" },
  { id: "inv36", name: "Card Reader (Smart/Mobile)", category: "Access Control", unit_cost: 350, unit: "each", description: "Multi-technology reader: smart card, fob, mobile credential, Bluetooth" },
  { id: "inv37", name: "Electric Strike", category: "Access Control", unit_cost: 220, unit: "each", description: "Fail-secure electric strike for access-controlled doors" },
  { id: "inv38", name: "Magnetic Door Lock (600lb)", category: "Access Control", unit_cost: 280, unit: "each", description: "600lb holding force electromagnetic lock with LED status" },
  { id: "inv39", name: "Request-to-Exit (REX) Sensor", category: "Access Control", unit_cost: 85, unit: "each", description: "Passive infrared request-to-exit motion sensor" },
  { id: "inv40", name: "Access Control Software License", category: "Access Control", unit_cost: 1500, unit: "per site", description: "Cloud-based access control management software, annual license" },
  { id: "inv41", name: "Visitor Management Kiosk", category: "Access Control", unit_cost: 2800, unit: "each", description: "Tablet-based visitor check-in kiosk with badge printing and ID scanning" },
  // Fire Lane
  { id: "inv42", name: "Fire Lane Striping (per linear ft)", category: "Fire Lane", unit_cost: 4, unit: "per linear ft", description: "Red curb striping with reflective paint, includes surface prep" },
  { id: "inv43", name: "Fire Lane Sign (post-mounted)", category: "Fire Lane", unit_cost: 175, unit: "each", description: "Regulatory fire lane sign on galvanized post, meets local code" },
  { id: "inv44", name: "Fire Lane Sign (wall-mounted)", category: "Fire Lane", unit_cost: 85, unit: "each", description: "Wall-mounted fire lane / no parking sign, aluminum" },
  { id: "inv45", name: "Fire Lane Stencil Marking", category: "Fire Lane", unit_cost: 65, unit: "each", description: "FIRE LANE stencil lettering on pavement, reflective thermoplastic" },
  { id: "inv46", name: "Fire Lane Bollard", category: "Fire Lane", unit_cost: 450, unit: "each", description: "Steel bollard with reflective tape, concrete-set, protects fire connections" },
  { id: "inv47", name: "Fire Lane Assessment & Mapping", category: "Fire Lane", unit_cost: 500, unit: "per facility", description: "Survey and map all fire lanes, hydrant access, and FDC zones per facility" },
  // Consulting Fees
  { id: "inv48", name: "Initial Compliance Consultation", category: "Consulting", unit_cost: 500, unit: "per session", description: "2-hour initial consultation including document review and scope discussion" },
  { id: "inv49", name: "On-Site Compliance Assessment (Small)", category: "Consulting", unit_cost: 2000, unit: "per facility", description: "Full compliance walkthrough for small facility (<20,000 sq ft)" },
  { id: "inv50", name: "On-Site Compliance Assessment (Mid)", category: "Consulting", unit_cost: 3000, unit: "per facility", description: "Full compliance walkthrough for mid-size facility (20,000-60,000 sq ft)" },
  { id: "inv51", name: "On-Site Compliance Assessment (Large)", category: "Consulting", unit_cost: 4000, unit: "per facility", description: "Full compliance walkthrough for large/complex facility (60,000+ sq ft)" },
  { id: "inv52", name: "Fire Marshal Coordination Fee", category: "Consulting", unit_cost: 1500, unit: "per facility", description: "Fire Marshal liaison services: scheduling, inspection attendance, advocacy" },
  { id: "inv53", name: "Compliance Report Generation", category: "Consulting", unit_cost: 750, unit: "per report", description: "Individual facility compliance report with photos, code references, and prioritized findings" },
  { id: "inv54", name: "Master Compliance Summary", category: "Consulting", unit_cost: 2500, unit: "per district", description: "District-wide master compliance summary with executive overview and cost estimates" },
  { id: "inv55", name: "Project Management Fee", category: "Consulting", unit_cost: 125, unit: "per hour", description: "Remediation project management and oversight, billed hourly" },
  { id: "inv56", name: "Code Consultation / Expert Witness", category: "Consulting", unit_cost: 200, unit: "per hour", description: "Fire code consultation, code interpretation, or expert witness services" },
  { id: "inv57", name: "Business Continuity Planning", category: "Consulting", unit_cost: 3500, unit: "per plan", description: "Fire safety business continuity plan development for commercial clients" },
  { id: "inv58", name: "Staff Fire Safety Training", category: "Consulting", unit_cost: 800, unit: "per session", description: "On-site fire safety training for staff, up to 30 attendees, includes materials" },
];

const DEFAULT_PROCEDURES = [
  { id: "proc1", name: "Initial Site Assessment", category: "Assessment", steps: "1. Request all existing fire safety documentation from client\n2. Review previous Fire Marshal inspection reports\n3. Obtain building blueprints and floor plans\n4. Identify building occupancy classification\n5. Determine applicable fire codes (IFC, NFPA)\n6. Schedule on-site walkthrough", notes: "Allow 2-3 hours for initial document review per facility" },
  { id: "proc2", name: "On-Site Compliance Walkthrough", category: "Assessment", steps: "1. Fire alarm system test (pull stations, detectors, notification)\n2. Sprinkler system visual inspection (heads, valves, risers)\n3. Emergency exit route verification (signage, lighting, clearance)\n4. Fire extinguisher check (placement, certification, accessibility)\n5. Fire door inspection (closers, latches, gaps, rating labels)\n6. Electrical panel clearance verification (36\" minimum)\n7. Kitchen hood suppression inspection\n8. Occupancy load verification\n9. Stairwell pressurization test (if applicable)\n10. Fire pump test (if applicable)\n11. Document all deficiencies with photos\n12. Rate each finding by priority (Critical/High/Medium/Low)", notes: "Typical walkthrough: 1-2 hours for small facility, 3-4 hours for large/complex. Bring camera, clipboard, PPE." },
  { id: "proc3", name: "Fire Marshal Coordination", category: "Coordination", steps: "1. Compile assessment findings into Fire Marshal-ready format\n2. Schedule pre-inspection meeting with FM office\n3. Present compliance plan and remediation timeline\n4. Negotiate reasonable compliance deadlines\n5. Attend formal inspection as client representative\n6. Document all FM requirements and action items\n7. Provide written summary to client within 24 hours", notes: "Always establish rapport with FM early. Position as their ally in getting the building compliant." },
  { id: "proc4", name: "Compliance Report Generation", category: "Reporting", steps: "1. Organize findings by system category\n2. Assign priority ratings to each deficiency\n3. Include photo documentation for each finding\n4. Reference specific code sections for each violation\n5. Provide remediation recommendations with cost estimates\n6. Create executive summary for leadership\n7. Generate facility compliance score (0-100%)\n8. Deliver digital report within 5 business days of assessment", notes: "Use Chatman report template. Always include the consulting fee offset mention in recommendations." },
  { id: "proc5", name: "Cost Estimation Process", category: "Estimating", steps: "1. List all required remediation items from assessment\n2. Pull current pricing from inventory database\n3. Calculate labor hours per item\n4. Apply volume discounts for multi-facility contracts\n5. Add project management overhead (12-15%)\n6. Include permit and inspection fees\n7. Break down by priority tier (Critical/High/Medium/Low)\n8. Present phased payment options\n9. Include consulting fee offset calculation", notes: "Standard markup on equipment: 25-35%. Labor rate: $85-$125/hr depending on trade. Always show the offset value prominently." },
  { id: "proc6", name: "Remediation Project Management", category: "Project Mgmt", steps: "1. Develop master project schedule\n2. Secure necessary permits\n3. Coordinate subcontractor scheduling\n4. Conduct weekly progress meetings with client\n5. Perform quality inspections at each milestone\n6. Document all work with photos and sign-offs\n7. Schedule Fire Marshal re-inspection\n8. Obtain certificate of compliance\n9. Deliver final project close-out package", notes: "This is where the real revenue is. Consulting fee offset makes us the natural choice for the remediation work." },
];

const CATEGORIES = ["Fire Alarm", "Sprinkler", "Extinguisher", "Egress", "Suppression", "Passive", "Monitoring", "Inspection", "Security Alarm", "Cameras", "Access Control", "Fire Lane", "Consulting", "Other"];

// ── Storage helpers ──
async function loadData(key, fallback) {
  const endpoints = {
    "csf-inventory": "/api/proposal-agent/inventory",
    "csf-procedures": "/api/proposal-agent/procedures",
    "csf-clients": "/api/proposal-agent/clients",
    "csf-proposals": "/api/proposal-agent/proposals",
  };
  try {
    const ep = endpoints[key];
    if (!ep) return fallback;
    const res = await fetch(ep);
    const json = await res.json();
    return json.data || fallback;
  } catch { return fallback; }
}

async function saveData(key, data) {
  // No-op: data is saved via individual CRUD operations now
}

// ── Tiny ID ──
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

// ── Styles ──
// sidebar removed - using admin layout sidebar
const mainS = { minHeight: "auto" };
const btnS = (primary) => ({ padding: "8px 16px", background: primary ? O : "#FFF", color: primary ? "#FFF" : "#4B5563", border: primary ? "none" : "1px solid #E5E7EB", borderRadius: 8, fontSize: 13, fontWeight: 500, cursor: "pointer", transition: "all 0.15s" });
const inputS = { width: "100%", padding: "10px 12px", background: "#FFF", border: "1px solid #E5E7EB", borderRadius: 8, color: "#111827", fontSize: 13, outline: "none", fontFamily: "inherit" };
const labelS = { fontSize: 13, fontWeight: 500, color: "#374151", display: "block", marginBottom: 6 };
const cardS = { background: "#FFF", borderRadius: 12, border: "1px solid #E5E7EB", padding: 20 };
const tableHeaderS = { padding: "12px 16px", textAlign: "left", fontSize: 12, fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: 0.5, background: "#F9FAFB", borderBottom: "1px solid #E5E7EB" };
const tableCellS = { padding: "12px 16px", fontSize: 13, color: "#111827", borderBottom: "1px solid #F3F4F6" };
const badgeS = (color) => ({ padding: "4px 12px", borderRadius: 20, fontSize: 11, fontWeight: 500, background: `${color}15`, color });

// ── MAIN APP ──
// ── STEP INDICATOR ──
function StepIndicator({ steps, currentStep }) {
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 0, marginBottom: 24 }}>
      {steps.map((s, i) => (
        <div key={i} style={{ display: "flex", alignItems: "center" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <div style={{
              width: 28, height: 28, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center",
              fontSize: 12, fontWeight: 600,
              background: i < currentStep ? "#22C55E" : i === currentStep ? "#EA580C" : "#E5E7EB",
              color: i <= currentStep ? "#FFF" : "#6B7280"
            }}>
              {i < currentStep ? "✓" : i + 1}
            </div>
            <span style={{ fontSize: 13, fontWeight: i === currentStep ? 600 : 400, color: i === currentStep ? "#111827" : "#6B7280" }}>{s}</span>
          </div>
          {i < steps.length - 1 && <div style={{ width: 40, height: 2, background: i < currentStep ? "#22C55E" : "#E5E7EB", margin: "0 8px" }} />}
        </div>
      ))}
    </div>
  );
}

export default function ProposalAgent() {
  const [page, setPage] = useState("dashboard");
  const [inventory, setInventory] = useState([]);
  const [procedures, setProcedures] = useState([]);
  const [clients, setClients] = useState([]);
  const [proposals, setProposals] = useState([]);
  const [loaded, setLoaded] = useState(false);
  const [analysisResults, setAnalysisResults] = useState(null);
  // Shape: { type: "document"|"floorplan", findings: [...], summary: {...}, devices: [...], costRange: [low, high] }
  const [openDropdown, setOpenDropdown] = useState(null);

  useEffect(() => {
    (async () => {
      const [inv, proc, cli, prop] = await Promise.all([
        loadData("csf-inventory", DEFAULT_INVENTORY),
        loadData("csf-procedures", DEFAULT_PROCEDURES),
        loadData("csf-clients", []),
        loadData("csf-proposals", []),
      ]);
      setInventory(inv); setProcedures(proc); setClients(cli); setProposals(prop);
      setLoaded(true);
    })();
  }, []);

  // Auto-save on changes
  useEffect(() => { if (loaded) saveData("csf-inventory", inventory); }, [inventory, loaded]);
  useEffect(() => { if (loaded) saveData("csf-procedures", procedures); }, [procedures, loaded]);
  useEffect(() => { if (loaded) saveData("csf-clients", clients); }, [clients, loaded]);
  useEffect(() => { if (loaded) saveData("csf-proposals", proposals); }, [proposals, loaded]);

  const navGroups = [
    { key: "dashboard", label: "Dashboard", icon: "📊" },
    {
      label: "New Analysis", icon: "🔍",
      children: [
        { key: "docanalysis", label: "Document Analysis", icon: "📝" },
        { key: "floorplan", label: "Floor Plan Markup", icon: "🏗️" },
      ]
    },
    { key: "generate", label: "Create Proposal", icon: "🤖" },
    {
      label: "Data", icon: "📦",
      children: [
        { key: "inventory", label: "Inventory", icon: "📦" },
        { key: "procedures", label: "Procedures", icon: "📋" },
        { key: "clients", label: "Clients", icon: "👥" },
      ]
    },
    { key: "history", label: "History", icon: "📄" },
  ];

  if (!loaded) return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: "50vh", color: G }}>Loading database...</div>;

  return (
    <div style={{ color: W }}>
      {/* Page Header */}
      <div style={{ marginBottom: 24 }}>
        <h1 style={{ fontSize: 24, fontWeight: 700, color: W, margin: 0 }}>Proposal Agent</h1>
        <p style={{ fontSize: 14, color: G, marginTop: 4 }}>{inventory.length} items · {procedures.length} SOPs · {clients.length} clients</p>
      </div>

      {/* Grouped Nav Bar */}
      <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginBottom: 24, padding: "4px", background: "#F3F4F6", borderRadius: 10, position: "relative" }}>
        {navGroups.map((group, gi) => {
          if (group.children) {
            const activeChild = group.children.find(c => c.key === page);
            const isOpen = openDropdown === gi;
            return (
              <div key={gi} style={{ position: "relative" }}>
                <div onClick={() => setOpenDropdown(isOpen ? null : gi)} style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 14px", borderRadius: 8, cursor: "pointer", background: activeChild ? "#FFF" : "transparent", color: activeChild ? O : G, fontSize: 13, fontWeight: activeChild ? 600 : 400, transition: "all 0.15s", boxShadow: activeChild ? "0 1px 3px rgba(0,0,0,0.08)" : "none", userSelect: "none" }}>
                  <span style={{ fontSize: 14 }}>{activeChild ? activeChild.icon : group.icon}</span>
                  {activeChild ? activeChild.label : group.label}
                  <span style={{ fontSize: 10, marginLeft: 2, transition: "transform 0.15s", transform: isOpen ? "rotate(180deg)" : "rotate(0deg)" }}>▼</span>
                </div>
                {isOpen && (
                  <div style={{ position: "absolute", top: "calc(100% + 4px)", left: 0, background: "#FFF", border: "1px solid #E5E7EB", borderRadius: 10, boxShadow: "0 8px 24px rgba(0,0,0,0.12)", zIndex: 100, minWidth: 200, overflow: "hidden" }}>
                    {group.children.map(child => (
                      <div key={child.key} onClick={() => { setPage(child.key); setOpenDropdown(null); }} style={{ display: "flex", alignItems: "center", gap: 8, padding: "10px 16px", cursor: "pointer", background: page === child.key ? `${O}10` : "transparent", color: page === child.key ? O : "#374151", fontSize: 13, fontWeight: page === child.key ? 600 : 400, transition: "background 0.1s" }} onMouseEnter={e => { if (page !== child.key) e.currentTarget.style.background = "#F9FAFB"; }} onMouseLeave={e => { if (page !== child.key) e.currentTarget.style.background = "transparent"; }}>
                        <span style={{ fontSize: 14 }}>{child.icon}</span>
                        {child.label}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          }
          return (
            <div key={group.key} onClick={() => { setPage(group.key); setOpenDropdown(null); }} style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 14px", borderRadius: 8, cursor: "pointer", background: page === group.key ? "#FFF" : "transparent", color: page === group.key ? O : G, fontSize: 13, fontWeight: page === group.key ? 600 : 400, transition: "all 0.15s", boxShadow: page === group.key ? "0 1px 3px rgba(0,0,0,0.08)" : "none" }}>
              <span style={{ fontSize: 14 }}>{group.icon}</span>{group.label}
            </div>
          );
        })}
      </div>

      {/* Main Content */}
      <div style={mainS}>
        {page === "dashboard" && <DashboardPage inventory={inventory} procedures={procedures} clients={clients} proposals={proposals} setPage={setPage} />}
        {page === "inventory" && <InventoryPage inventory={inventory} setInventory={setInventory} />}
        {page === "procedures" && <ProceduresPage procedures={procedures} setProcedures={setProcedures} />}
        {page === "clients" && <ClientsPage clients={clients} setClients={setClients} />}
        {page === "floorplan" && <FloorPlanPage inventory={inventory} setAnalysisResults={setAnalysisResults} setPage={setPage} />}
        {page === "docanalysis" && <DocAnalysisPage inventory={inventory} procedures={procedures} setAnalysisResults={setAnalysisResults} setPage={setPage} />}
        {page === "generate" && <GeneratePage inventory={inventory} procedures={procedures} clients={clients} proposals={proposals} setProposals={setProposals} setClients={setClients} analysisResults={analysisResults} setAnalysisResults={setAnalysisResults} />}
        {page === "history" && <HistoryPage proposals={proposals} setProposals={setProposals} clients={clients} />}
      </div>
    </div>
  );
}

// ── PAGE HEADER ──
function PageHeader({ title, subtitle, action }) {
  return (
    <div style={{ padding: "24px 32px", borderBottom: `1px solid ${D4}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
      <div>
        <h1 style={{ margin: 0, fontSize: 20, fontWeight: 700 }}>{title}</h1>
        {subtitle && <p style={{ margin: "4px 0 0", fontSize: 13, color: G }}>{subtitle}</p>}
      </div>
      {action}
    </div>
  );
}

// ═══════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════
function DashboardPage({ inventory, procedures, clients, proposals, setPage }) {
  const totalValue = inventory.reduce((s, i) => s + i.unit_cost, 0);
  const stats = [
    { label: "Inventory Items", value: inventory.length, icon: "📦", color: BL, sub: `${CATEGORIES.filter(c => inventory.some(i => i.category === c)).length} categories` },
    { label: "SOPs / Procedures", value: procedures.length, icon: "📋", color: GR, sub: "Standardized workflows" },
    { label: "Clients", value: clients.length, icon: "👥", color: O, sub: `${clients.filter(c => c.org_type === "school_district").length} school districts` },
    { label: "Proposals Generated", value: proposals.length, icon: "📄", color: YL, sub: `${proposals.filter(p => p.status === "sent").length} sent, ${proposals.filter(p => p.status === "won").length} won` },
  ];

  return (
    <div>
      <PageHeader title="Dashboard" subtitle="Chatman Security & Fire — Proposal Agent" />
      <div style={{ padding: 32 }}>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginBottom: 32 }}>
          {stats.map((s, i) => (
            <div key={i} style={{ ...cardS, position: "relative", overflow: "hidden" }}>
              <div style={{ fontSize: 28, marginBottom: 4 }}>{s.icon}</div>
              <div style={{ fontSize: 11, color: G, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 4 }}>{s.label}</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: s.color }}>{s.value}</div>
              <div style={{ fontSize: 11, color: G, marginTop: 4 }}>{s.sub}</div>
              <div style={{ position: "absolute", top: -20, right: -20, width: 80, height: 80, borderRadius: "50%", background: `${s.color}08` }} />
            </div>
          ))}
        </div>

        {/* Workflow Action Cards */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
          <div onClick={() => setPage("docanalysis")} style={{ ...cardS, cursor: "pointer", borderLeft: "4px solid #EA580C", transition: "all 0.15s" }} onMouseEnter={e => e.currentTarget.style.boxShadow = "0 4px 16px rgba(0,0,0,0.08)"} onMouseLeave={e => e.currentTarget.style.boxShadow = "none"}>
            <div style={{ fontSize: 24, marginBottom: 8 }}>📝</div>
            <div style={{ fontSize: 16, fontWeight: 600, color: W, marginBottom: 4 }}>Analyze Document</div>
            <div style={{ fontSize: 13, color: G }}>Upload an inspection report, fire marshal checklist, or violation notice for AI-powered compliance analysis</div>
          </div>
          <div onClick={() => setPage("floorplan")} style={{ ...cardS, cursor: "pointer", borderLeft: "4px solid #3B82F6", transition: "all 0.15s" }} onMouseEnter={e => e.currentTarget.style.boxShadow = "0 4px 16px rgba(0,0,0,0.08)"} onMouseLeave={e => e.currentTarget.style.boxShadow = "none"}>
            <div style={{ fontSize: 24, marginBottom: 8 }}>🏗️</div>
            <div style={{ fontSize: 16, fontWeight: 600, color: W, marginBottom: 4 }}>Analyze Floor Plan</div>
            <div style={{ fontSize: 13, color: G }}>Upload a floor plan for device placement per NFPA 72 and IFC Chapter 9</div>
          </div>
        </div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
          <div style={cardS}>
            <h3 style={{ fontSize: 15, fontWeight: 700, marginBottom: 16, marginTop: 0 }}>Quick Actions</h3>
            {[
              { label: "Generate New Proposal", icon: "🤖", page: "generate" },
              { label: "Add New Client", icon: "👤", page: "clients" },
              { label: "Manage Inventory", icon: "📦", page: "inventory" },
              { label: "View Proposal History", icon: "📄", page: "history" },
            ].map((a, i) => (
              <div key={i} onClick={() => setPage(a.page)} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 14px", borderRadius: 8, cursor: "pointer", marginBottom: 4, transition: "background 0.15s", background: "transparent" }} onMouseEnter={e => e.currentTarget.style.background = D4} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                <span style={{ fontSize: 18 }}>{a.icon}</span>
                <span style={{ fontSize: 13, fontWeight: 500 }}>{a.label}</span>
                <span style={{ marginLeft: "auto", color: G, fontSize: 12 }}>→</span>
              </div>
            ))}
          </div>
          <div style={cardS}>
            <h3 style={{ fontSize: 15, fontWeight: 700, marginBottom: 16, marginTop: 0 }}>Recent Proposals</h3>
            {proposals.length === 0 ? (
              <div style={{ color: G, fontSize: 13, padding: "20px 0", textAlign: "center" }}>No proposals yet. Generate your first one!</div>
            ) : (
              proposals.slice(-5).reverse().map((p, i) => {
                const cl = clients.find(c => c.id === p.client_id);
                return (
                  <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 0", borderBottom: i < Math.min(proposals.length, 5) - 1 ? `1px solid ${D4}` : "none" }}>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600 }}>{cl?.name || "Unknown Client"}</div>
                      <div style={{ fontSize: 11, color: G }}>Tier {p.tier} · {new Date(p.created_at).toLocaleDateString()}</div>
                    </div>
                    <span style={badgeS(p.status === "won" ? GR : p.status === "sent" ? BL : p.status === "lost" ? RD : G)}>{p.status}</span>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  INVENTORY PAGE
// ═══════════════════════════════════════
function InventoryPage({ inventory, setInventory }) {
  const [editing, setEditing] = useState(null);
  const [filter, setFilter] = useState("All");

  const filtered = filter === "All" ? inventory : inventory.filter(i => i.category === filter);
  const cats = ["All", ...CATEGORIES.filter(c => inventory.some(i => i.category === c))];

  async function saveItem(item) {
    if (item.id) {
      setInventory(prev => prev.map(i => i.id === item.id ? item : i));
      fetch("/api/proposal-agent/inventory", { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(item) }).catch(console.error);
    } else {
      const newItem = { ...item, id: uid() };
      setInventory(prev => [...prev, newItem]);
      fetch("/api/proposal-agent/inventory", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newItem) }).catch(console.error);
    }
    setEditing(null);
  }

  async function deleteItem(id) {
    setInventory(prev => prev.filter(i => i.id !== id));
    fetch(`/api/proposal-agent/inventory?id=${id}`, { method: "DELETE" }).catch(console.error);
  }

  return (
    <div>
      <PageHeader title="Inventory & Pricing" subtitle={`${inventory.length} items across ${CATEGORIES.filter(c => inventory.some(i => i.category === c)).length} categories`} action={<button style={btnS(true)} onClick={() => setEditing({ name: "", category: "Fire Alarm", unit_cost: 0, unit: "each", description: "" })}>+ Add Item</button>} />
      <div style={{ padding: "20px 32px" }}>
        <div style={{ display: "flex", gap: 6, marginBottom: 20, flexWrap: "wrap" }}>
          {cats.map(c => (
            <button key={c} onClick={() => setFilter(c)} style={{ padding: "6px 14px", borderRadius: 20, border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", background: filter === c ? O : D4, color: filter === c ? "#fff" : G }}>{c}</button>
          ))}
        </div>
        <div style={{ borderRadius: 12, overflow: "hidden", border: `1px solid ${D4}` }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead><tr style={{ background: D3 }}>
              {["Item", "Category", "Unit Cost", "Unit", ""].map((h, i) => <th key={i} style={tableHeaderS}>{h}</th>)}
            </tr></thead>
            <tbody>
              {filtered.map(item => (
                <tr key={item.id} style={{ background: D2 }} onMouseEnter={e => e.currentTarget.style.background = D3} onMouseLeave={e => e.currentTarget.style.background = D2}>
                  <td style={tableCellS}>
                    <div style={{ fontWeight: 600 }}>{item.name}</div>
                    <div style={{ fontSize: 11, color: G, marginTop: 2 }}>{item.description}</div>
                  </td>
                  <td style={tableCellS}><span style={badgeS(O)}>{item.category}</span></td>
                  <td style={{ ...tableCellS, fontWeight: 700, color: GR }}>${item.unit_cost.toLocaleString()}</td>
                  <td style={{ ...tableCellS, color: G }}>{item.unit}</td>
                  <td style={{ ...tableCellS, textAlign: "right" }}>
                    <button style={{ ...btnS(false), padding: "5px 10px", fontSize: 11, marginRight: 6 }} onClick={() => setEditing(item)}>Edit</button>
                    <button style={{ ...btnS(false), padding: "5px 10px", fontSize: 11, background: `${RD}20`, color: RD }} onClick={() => deleteItem(item.id)}>×</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      {editing && <ItemModal item={editing} onSave={saveItem} onClose={() => setEditing(null)} />}
    </div>
  );
}

function ItemModal({ item, onSave, onClose }) {
  const [form, setForm] = useState(item);
  const u = (k, v) => setForm(p => ({ ...p, [k]: v }));
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={onClose}>
      <div style={{ ...cardS, width: 480, maxHeight: "80vh", overflow: "auto" }} onClick={e => e.stopPropagation()}>
        <h3 style={{ margin: "0 0 20px", fontSize: 16, fontWeight: 700 }}>{item.id ? "Edit Item" : "Add Item"}</h3>
        <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
          <div><label style={labelS}>Name</label><input style={inputS} value={form.name} onChange={e => u("name", e.target.value)} /></div>
          <div><label style={labelS}>Category</label>
            <select style={{ ...inputS, cursor: "pointer" }} value={form.category} onChange={e => u("category", e.target.value)}>
              {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
            <div><label style={labelS}>Unit Cost ($)</label><input style={inputS} type="number" value={form.unit_cost} onChange={e => u("unit_cost", Number(e.target.value))} /></div>
            <div><label style={labelS}>Unit</label><input style={inputS} value={form.unit} onChange={e => u("unit", e.target.value)} /></div>
          </div>
          <div><label style={labelS}>Description</label><textarea style={{ ...inputS, resize: "vertical" }} rows={2} value={form.description} onChange={e => u("description", e.target.value)} /></div>
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 8 }}>
            <button style={btnS(false)} onClick={onClose}>Cancel</button>
            <button style={btnS(true)} onClick={() => form.name && onSave(form)}>Save</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  PROCEDURES PAGE
// ═══════════════════════════════════════
function ProceduresPage({ procedures, setProcedures }) {
  const [editing, setEditing] = useState(null);
  const [expanded, setExpanded] = useState(null);

  async function saveProc(proc) {
    if (proc.id) {
      setProcedures(prev => prev.map(p => p.id === proc.id ? proc : p));
      fetch("/api/proposal-agent/procedures", { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(proc) }).catch(console.error);
    } else {
      const newProc = { ...proc, id: uid() };
      setProcedures(prev => [...prev, newProc]);
      fetch("/api/proposal-agent/procedures", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newProc) }).catch(console.error);
    }
    setEditing(null);
  }

  return (
    <div>
      <PageHeader title="Procedures & SOPs" subtitle={`${procedures.length} standardized operating procedures`} action={<button style={btnS(true)} onClick={() => setEditing({ name: "", category: "Assessment", steps: "", notes: "" })}>+ Add Procedure</button>} />
      <div style={{ padding: "20px 32px", display: "flex", flexDirection: "column", gap: 12 }}>
        {procedures.map(proc => (
          <div key={proc.id} style={cardS}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" }} onClick={() => setExpanded(expanded === proc.id ? null : proc.id)}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <span style={badgeS(BL)}>{proc.category}</span>
                <span style={{ fontSize: 14, fontWeight: 600 }}>{proc.name}</span>
              </div>
              <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                <button style={{ ...btnS(false), padding: "4px 10px", fontSize: 11 }} onClick={e => { e.stopPropagation(); setEditing(proc); }}>Edit</button>
                <span style={{ color: G, transform: expanded === proc.id ? "rotate(180deg)" : "rotate(0deg)", transition: "0.2s" }}>▼</span>
              </div>
            </div>
            {expanded === proc.id && (
              <div style={{ marginTop: 16, paddingTop: 16, borderTop: `1px solid ${D4}` }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: O, marginBottom: 8, textTransform: "uppercase" }}>Steps</div>
                <pre style={{ fontSize: 12, color: G, lineHeight: 1.7, margin: 0, whiteSpace: "pre-wrap", fontFamily: "inherit" }}>{proc.steps}</pre>
                {proc.notes && (
                  <>
                    <div style={{ fontSize: 11, fontWeight: 600, color: O, marginBottom: 8, marginTop: 16, textTransform: "uppercase" }}>Notes</div>
                    <p style={{ fontSize: 12, color: G, margin: 0 }}>{proc.notes}</p>
                  </>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
      {editing && <ProcModal proc={editing} onSave={saveProc} onClose={() => setEditing(null)} />}
    </div>
  );
}

function ProcModal({ proc, onSave, onClose }) {
  const [form, setForm] = useState(proc);
  const u = (k, v) => setForm(p => ({ ...p, [k]: v }));
  const cats = ["Assessment", "Coordination", "Reporting", "Estimating", "Project Mgmt", "Other"];
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={onClose}>
      <div style={{ ...cardS, width: 560, maxHeight: "85vh", overflow: "auto" }} onClick={e => e.stopPropagation()}>
        <h3 style={{ margin: "0 0 20px", fontSize: 16, fontWeight: 700 }}>{proc.id ? "Edit Procedure" : "Add Procedure"}</h3>
        <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
          <div><label style={labelS}>Name</label><input style={inputS} value={form.name} onChange={e => u("name", e.target.value)} /></div>
          <div><label style={labelS}>Category</label>
            <select style={{ ...inputS, cursor: "pointer" }} value={form.category} onChange={e => u("category", e.target.value)}>
              {cats.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div><label style={labelS}>Steps</label><textarea style={{ ...inputS, resize: "vertical" }} rows={8} value={form.steps} onChange={e => u("steps", e.target.value)} /></div>
          <div><label style={labelS}>Notes</label><textarea style={{ ...inputS, resize: "vertical" }} rows={3} value={form.notes} onChange={e => u("notes", e.target.value)} /></div>
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 8 }}>
            <button style={btnS(false)} onClick={onClose}>Cancel</button>
            <button style={btnS(true)} onClick={() => form.name && onSave(form)}>Save</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  CLIENTS PAGE
// ═══════════════════════════════════════
function ClientsPage({ clients, setClients }) {
  const [editing, setEditing] = useState(null);

  async function saveClient(cl) {
    if (cl.id) {
      setClients(prev => prev.map(c => c.id === cl.id ? cl : c));
      fetch("/api/proposal-agent/clients", { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(cl) }).catch(console.error);
    } else {
      const newCl = { ...cl, id: uid(), created_at: new Date().toISOString() };
      setClients(prev => [...prev, newCl]);
      fetch("/api/proposal-agent/clients", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newCl) }).catch(console.error);
    }
    setEditing(null);
  }

  async function deleteClient(id) {
    setClients(prev => prev.filter(c => c.id !== id));
    fetch(`/api/proposal-agent/clients?id=${id}`, { method: "DELETE" }).catch(console.error);
  }

  return (
    <div>
      <PageHeader title="Clients" subtitle={`${clients.length} client records`} action={<button style={btnS(true)} onClick={() => setEditing({ name: "", contact_name: "", contact_title: "", contact_email: "", org_type: "school_district", num_facilities: "", address: "", notes: "" })}>+ Add Client</button>} />
      <div style={{ padding: "20px 32px" }}>
        {clients.length === 0 ? (
          <div style={{ ...cardS, textAlign: "center", padding: 60 }}>
            <div style={{ fontSize: 32, marginBottom: 12 }}>👥</div>
            <div style={{ fontSize: 15, fontWeight: 600, marginBottom: 6 }}>No clients yet</div>
            <div style={{ fontSize: 13, color: G, marginBottom: 20 }}>Add your first client or create one during proposal generation</div>
            <button style={btnS(true)} onClick={() => setEditing({ name: "", contact_name: "", contact_title: "", contact_email: "", org_type: "school_district", num_facilities: "", address: "", notes: "" })}>+ Add Client</button>
          </div>
        ) : (
          <div style={{ borderRadius: 12, overflow: "hidden", border: `1px solid ${D4}` }}>
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead><tr style={{ background: D3 }}>
                {["Client", "Contact", "Type", "Facilities", ""].map((h, i) => <th key={i} style={tableHeaderS}>{h}</th>)}
              </tr></thead>
              <tbody>
                {clients.map(cl => (
                  <tr key={cl.id} style={{ background: D2 }} onMouseEnter={e => e.currentTarget.style.background = D3} onMouseLeave={e => e.currentTarget.style.background = D2}>
                    <td style={tableCellS}>
                      <div style={{ fontWeight: 600 }}>{cl.name}</div>
                      <div style={{ fontSize: 11, color: G }}>{cl.address}</div>
                    </td>
                    <td style={tableCellS}>
                      <div>{cl.contact_name}</div>
                      <div style={{ fontSize: 11, color: G }}>{cl.contact_title}</div>
                    </td>
                    <td style={tableCellS}><span style={badgeS(O)}>{cl.org_type.replace(/_/g, " ")}</span></td>
                    <td style={{ ...tableCellS, fontWeight: 700 }}>{cl.num_facilities || "—"}</td>
                    <td style={{ ...tableCellS, textAlign: "right" }}>
                      <button style={{ ...btnS(false), padding: "5px 10px", fontSize: 11, marginRight: 6 }} onClick={() => setEditing(cl)}>Edit</button>
                      <button style={{ ...btnS(false), padding: "5px 10px", fontSize: 11, background: `${RD}20`, color: RD }} onClick={() => deleteClient(cl.id)}>×</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
      {editing && <ClientModal client={editing} onSave={saveClient} onClose={() => setEditing(null)} />}
    </div>
  );
}

function ClientModal({ client, onSave, onClose }) {
  const [form, setForm] = useState(client);
  const u = (k, v) => setForm(p => ({ ...p, [k]: v }));
  const types = [["school_district","School District"],["commercial","Commercial"],["healthcare","Healthcare"],["government","Government"],["industrial","Industrial"],["other","Other"]];
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={onClose}>
      <div style={{ ...cardS, width: 520, maxHeight: "85vh", overflow: "auto" }} onClick={e => e.stopPropagation()}>
        <h3 style={{ margin: "0 0 20px", fontSize: 16, fontWeight: 700 }}>{client.id ? "Edit Client" : "Add Client"}</h3>
        <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
          <div><label style={labelS}>Organization Name</label><input style={inputS} value={form.name} onChange={e => u("name", e.target.value)} /></div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
            <div><label style={labelS}>Contact Name</label><input style={inputS} value={form.contact_name} onChange={e => u("contact_name", e.target.value)} /></div>
            <div><label style={labelS}>Contact Title</label><input style={inputS} value={form.contact_title} onChange={e => u("contact_title", e.target.value)} /></div>
          </div>
          <div><label style={labelS}>Contact Email</label><input style={inputS} value={form.contact_email} onChange={e => u("contact_email", e.target.value)} /></div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
            <div><label style={labelS}>Organization Type</label>
              <select style={{ ...inputS, cursor: "pointer" }} value={form.org_type} onChange={e => u("org_type", e.target.value)}>
                {types.map(([v,l]) => <option key={v} value={v}>{l}</option>)}
              </select>
            </div>
            <div><label style={labelS}>Number of Facilities</label><input style={inputS} type="number" value={form.num_facilities} onChange={e => u("num_facilities", e.target.value)} /></div>
          </div>
          <div><label style={labelS}>Address</label><input style={inputS} value={form.address} onChange={e => u("address", e.target.value)} /></div>
          <div><label style={labelS}>Notes</label><textarea style={{ ...inputS, resize: "vertical" }} rows={2} value={form.notes} onChange={e => u("notes", e.target.value)} /></div>
          <div style={{ display: "flex", gap: 10, justifyContent: "flex-end", marginTop: 8 }}>
            <button style={btnS(false)} onClick={onClose}>Cancel</button>
            <button style={btnS(true)} onClick={() => form.name && onSave(form)}>Save</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  FLOOR PLAN MARKUP PAGE
// ═══════════════════════════════════════
const DEVICE_TYPES = {
  smoke_detector: { icon: "🔴", label: "Smoke Detector", color: "#EF4444", code: "NFPA 72 §17.7.3" },
  heat_detector: { icon: "🟠", label: "Heat Detector", color: "#F97316", code: "NFPA 72 §17.6" },
  pull_station: { icon: "🟥", label: "Pull Station", color: "#DC2626", code: "NFPA 72 §17.14 / IFC §907.4.2" },
  horn_strobe: { icon: "🔔", label: "Horn/Strobe", color: "#EAB308", code: "NFPA 72 §18.4" },
  sprinkler_head: { icon: "💧", label: "Sprinkler Head", color: "#3B82F6", code: "NFPA 13 / IFC §903" },
  exit_sign: { icon: "🚪", label: "Exit Sign", color: "#22C55E", code: "IFC §1013 / NFPA 101" },
  emergency_light: { icon: "💡", label: "Emergency Light", color: "#A3E635", code: "IFC §1008.3" },
  fire_extinguisher: { icon: "🧯", label: "Fire Extinguisher", color: "#F43F5E", code: "IFC §906 / NFPA 10" },
  camera: { icon: "📷", label: "Camera", color: "#8B5CF6", code: "Site security plan" },
  card_reader: { icon: "🔐", label: "Access Reader", color: "#06B6D4", code: "Access control plan" },
  motion_sensor: { icon: "📡", label: "Motion Sensor", color: "#EC4899", code: "Security plan" },
  duct_detector: { icon: "🌀", label: "Duct Detector", color: "#FB923C", code: "NFPA 72 §17.7.5 / IMC §606" },
};

const FLOORPLAN_SYSTEM_PROMPT = `You are a fire & life safety code compliance expert for Chatman Security & Fire. You analyze floor plans and determine device placement per NFPA 72 (National Fire Alarm and Signaling Code) and IFC Chapter 9 (Fire Protection and Life Safety Systems).

CRITICAL CODE REQUIREMENTS:

SMOKE DETECTORS (NFPA 72 §17.7.3):
- Spacing: Max 30ft between detectors on smooth ceilings
- Wall offset: Min 4 inches, max 12 inches from wall/ceiling junction for sidewall mount; ceiling mount min 4in from any wall
- Coverage area: 900 sq ft max per detector on smooth ceiling (30ft x 30ft grid)
- Required locations: corridors, storage rooms, lobbies, mechanical rooms, above dropped ceilings if combustibles present
- Corridors: max 30ft apart, max 15ft from end walls
- High ceilings (>10ft): may require closer spacing per engineering calculations

HEAT DETECTORS (NFPA 72 §17.6):
- Spacing: Max 50ft on smooth ceiling
- Coverage: 2,500 sq ft max per detector
- Use in: kitchens, mechanical rooms, garages, boiler rooms (where smoke detectors would false alarm)
- Not a substitute for smoke detectors in sleeping areas

MANUAL PULL STATIONS (NFPA 72 §17.14 / IFC §907.4.2):
- Required within 5ft of EACH exit doorway on each floor
- Max 200ft travel distance to nearest pull station
- Mount 42-48 inches AFF (above finished floor)
- Must be unobstructed and readily accessible

NOTIFICATION APPLIANCES - HORN/STROBES (NFPA 72 §18.4):
- Audible: min 15dB above ambient or 5dB above max sound, whichever is greater
- Visible (strobes): entire floor area must have coverage:
  * Room ≤20x20ft: 15 cd
  * Room ≤28x28ft: 30 cd  
  * Room ≤40x40ft: 60 cd
  * Room ≤54x54ft: 110 cd
  * Corridors: 15 cd max 100ft apart
- Wall-mount strobes: 80-96 inches AFF
- ADA compliance required in all public areas

SPRINKLER HEADS (NFPA 13 referenced by IFC §903):
- Light hazard (offices, schools): max 225 sq ft per head, max 15ft spacing
- Ordinary hazard Group 1: max 130 sq ft per head
- Distance from walls: min 4 inches, max half the allowable distance between sprinklers
- Coverage must extend to within a few feet of every wall
- Required in closets >24 sq ft, under stairs, in mezzanines

EXIT SIGNS (IFC §1013):
- Required at every exit door and exit access door
- Required along exit access corridors where the exit path is not immediately visible
- Must be visible from any direction of egress travel
- Max 100ft viewing distance (6in letters) or 75ft (small letters)
- Illuminated (internal or external), with 90-min battery backup

EMERGENCY LIGHTING (IFC §1008.3):
- Required in all exit access corridors, stairs, exit discharge areas
- Min 1 foot-candle average, 0.1 foot-candle minimum at floor level
- 90-minute battery backup required
- Typically spaced every 20-25ft in corridors

FIRE EXTINGUISHERS (IFC §906 / NFPA 10):
- Max 75ft travel distance to Class A extinguisher
- Max 50ft travel distance to Class B/C extinguisher
- Mount 3.5-5ft AFF (top handle)
- Minimum rating: 2A:10B:C for light hazard
- Required within 30ft of commercial cooking equipment
- Visible, accessible, along normal paths of travel

WHEN ANALYZING A FLOOR PLAN:
1. Identify all rooms, corridors, exits, and approximate dimensions
2. Place smoke detectors in 30ft grid pattern in all habitable spaces
3. Use heat detectors in kitchens, mechanical rooms, garages
4. Place pull stations at every exit door
5. Place horn/strobes for full audible/visual coverage
6. Place sprinkler heads in ~15ft grid for light hazard occupancy
7. Place exit signs at all exits and along path to exits
8. Place emergency lights along corridors, stairs, exit paths
9. Place extinguishers for max 75ft travel distance
10. Consider cameras at entry/exit points and parking areas
11. Consider access control readers at main entries and secure areas

RESPONSE FORMAT:
You MUST respond with ONLY valid JSON, no markdown, no backticks, no explanation before or after. The JSON must have this exact structure:
{
  "analysis": "Brief text describing what you see in the floor plan and your overall approach",
  "devices": [
    {
      "type": "smoke_detector",
      "x": 25.5,
      "y": 30.2,
      "label": "SD-1",
      "note": "Corridor coverage, 30ft from entry",
      "code_ref": "NFPA 72 §17.7.3.1"
    }
  ],
  "code_notes": [
    "Brief note about a specific code requirement applied here"
  ],
  "estimated_cost": {
    "description": "Brief cost summary",
    "total_low": 15000,
    "total_high": 22000
  }
}

x and y are PERCENTAGE positions (0-100) relative to the image dimensions.
Place devices precisely where they should go on the floor plan.
Use device types: smoke_detector, heat_detector, pull_station, horn_strobe, sprinkler_head, exit_sign, emergency_light, fire_extinguisher, camera, card_reader, motion_sensor, duct_detector
Label devices sequentially: SD-1, SD-2 for smoke detectors, PS-1, PS-2 for pull stations, etc.
Be thorough - a real compliance plan needs EVERY required device placed.`;

function FloorPlanPage({ inventory, setAnalysisResults, setPage }) {
  const [image, setImage] = useState(null);
  const [imageSize, setImageSize] = useState({ w: 0, h: 0 });
  const [devices, setDevices] = useState([]);
  const [analysis, setAnalysis] = useState("");
  const [codeNotes, setCodeNotes] = useState([]);
  const [costEstimate, setCostEstimate] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [selectedDevice, setSelectedDevice] = useState(null);
  const [visibleTypes, setVisibleTypes] = useState(Object.keys(DEVICE_TYPES));
  const [buildingType, setBuildingType] = useState("school");
  const [facilityName, setFacilityName] = useState("");
  const [showLegend, setShowLegend] = useState(true);
  const canvasRef = useRef(null);
  const imgRef = useRef(null);
  const [fpStep, setFpStep] = useState(0); // 0=Upload, 1=Device Placement, 2=Review & Correct, 3=transition
  const [editableDevices, setEditableDevices] = useState([]);

  function handleUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => setImageSize({ w: img.naturalWidth, h: img.naturalHeight });
      img.src = ev.target.result;
      setImage(ev.target.result);
      setDevices([]);
      setAnalysis("");
      setCodeNotes([]);
      setCostEstimate(null);
      setError("");
    };
    reader.readAsDataURL(file);
  }

  async function analyzeFloorPlan() {
    if (!image) return;
    setLoading(true);
    setError("");
    setDevices([]);
    setAnalysis("");

    const invSummary = inventory.map(i => `${i.name}: $${i.unit_cost}/${i.unit}`).join("\n");

    try {
      const mediaType = image.startsWith("data:image/png") ? "image/png" : "image/jpeg";
      const b64Data = image.split(",")[1];

      const resp = await fetch("/api/claude", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          system: FLOORPLAN_SYSTEM_PROMPT + "\n\nBUILDING TYPE: " + buildingType + "\nFACILITY: " + (facilityName || "Not specified") + "\n\nAVAILABLE INVENTORY & PRICING:\n" + invSummary,
          messages: [{
            role: "user",
            content: [
              { type: "image", source: { type: "base64", media_type: mediaType, data: b64Data } },
              { type: "text", text: "Analyze this floor plan and provide complete device placement per NFPA 72 and IFC Chapter 9. Place every required device with precise x,y percentage coordinates. Include fire alarm, detection, notification, suppression, egress, extinguishers, and security devices. Be thorough — this is for a real compliance plan. Respond with ONLY the JSON object, no other text." }
            ]
          }]
        }),
      });

      const data = await resp.json();
      const text = data.content?.map(b => b.type === "text" ? b.text : "").filter(Boolean).join("\n") || "";

      // Parse JSON - handle potential markdown wrapping
      const cleaned = text.replace(/```json\s*/g, "").replace(/```\s*/g, "").trim();
      const parsed = JSON.parse(cleaned);

      if (parsed.devices && Array.isArray(parsed.devices)) {
        setDevices(parsed.devices);
        setAnalysis(parsed.analysis || "");
        setCodeNotes(parsed.code_notes || []);
        setCostEstimate(parsed.estimated_cost || null);
        // Build editable device list grouped by type
        const grouped = {};
        parsed.devices.forEach(d => {
          const dt = DEVICE_TYPES[d.type];
          if (!grouped[d.type]) {
            const invItem = inventory.find(i => i.name.toLowerCase().includes(dt?.label?.split(" ")[0]?.toLowerCase() || ""));
            grouped[d.type] = { type: d.type, label: dt?.label || d.type, code: dt?.code || "", quantity: 0, unitCost: invItem?.unit_cost || 0, _id: d.type };
          }
          grouped[d.type].quantity++;
        });
        setEditableDevices(Object.values(grouped));
        setFpStep(1);
      } else {
        setError("Unexpected response format. Please try again.");
      }
    } catch (err) {
      console.error(err);
      setError("Failed to analyze floor plan: " + err.message + ". Try again.");
    }
    setLoading(false);
  }

  function toggleType(type) {
    setVisibleTypes(prev => prev.includes(type) ? prev.filter(t => t !== type) : [...prev, type]);
  }

  function exportMarkup() {
    const canvas = document.createElement("canvas");
    const img = imgRef.current;
    if (!img) return;

    const scale = 2;
    canvas.width = img.clientWidth * scale;
    canvas.height = img.clientHeight * scale;
    const ctx = canvas.getContext("2d");
    ctx.scale(scale, scale);

    // Draw floor plan
    ctx.drawImage(img, 0, 0, img.clientWidth, img.clientHeight);

    // Draw devices
    devices.filter(d => visibleTypes.includes(d.type)).forEach(d => {
      const dt = DEVICE_TYPES[d.type] || DEVICE_TYPES.smoke_detector;
      const px = (d.x / 100) * img.clientWidth;
      const py = (d.y / 100) * img.clientHeight;

      // Circle background
      ctx.beginPath();
      ctx.arc(px, py, 12, 0, Math.PI * 2);
      ctx.fillStyle = dt.color;
      ctx.globalAlpha = 0.9;
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Label
      ctx.fillStyle = "#fff";
      ctx.font = "bold 8px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(d.label || "", px, py);
    });

    // Legend
    if (showLegend) {
      const usedTypes = [...new Set(devices.map(d => d.type))];
      const lx = 10, ly = canvas.height / scale - usedTypes.length * 20 - 30;
      ctx.fillStyle = "rgba(0,0,0,0.75)";
      ctx.fillRect(lx, ly, 200, usedTypes.length * 20 + 25);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 10px sans-serif";
      ctx.textAlign = "left";
      ctx.fillText("DEVICE LEGEND", lx + 8, ly + 14);
      usedTypes.forEach((t, i) => {
        const dt = DEVICE_TYPES[t];
        ctx.beginPath();
        ctx.arc(lx + 16, ly + 32 + i * 20, 6, 0, Math.PI * 2);
        ctx.fillStyle = dt.color;
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "9px sans-serif";
        ctx.fillText(`${dt.label} (${devices.filter(d => d.type === t).length})`, lx + 28, ly + 35 + i * 20);
      });
    }

    const link = document.createElement("a");
    link.download = `FloorPlan_Markup_${facilityName || "plan"}_${new Date().toISOString().slice(0, 10)}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  const buildingTypes = [["school", "School / K-12"], ["commercial", "Commercial Office"], ["healthcare", "Healthcare"], ["warehouse", "Warehouse / Industrial"], ["retail", "Retail"], ["restaurant", "Restaurant / Kitchen"], ["church", "Assembly / Church"], ["residential", "Multi-Family Residential"]];
  const usedTypes = [...new Set(devices.map(d => d.type))];
  const filteredDevices = devices.filter(d => visibleTypes.includes(d.type));

  // Editable devices helpers
  const fpTotalCostLow = editableDevices.reduce((s, d) => s + (d.quantity * d.unitCost * 0.9), 0);
  const fpTotalCostHigh = editableDevices.reduce((s, d) => s + (d.quantity * d.unitCost * 1.15), 0);
  const fpTotalEquipment = editableDevices.reduce((s, d) => s + (d.quantity * d.unitCost), 0);

  function updateDevice(idx, field, value) {
    setEditableDevices(prev => prev.map((d, i) => i === idx ? { ...d, [field]: value } : d));
  }

  function removeDevice(idx) {
    setEditableDevices(prev => prev.filter((_, i) => i !== idx));
  }

  function addDevice() {
    const defaultType = Object.keys(DEVICE_TYPES)[0];
    const dt = DEVICE_TYPES[defaultType];
    setEditableDevices(prev => [...prev, { _id: Date.now().toString(), type: defaultType, label: dt.label, code: dt.code, quantity: 1, unitCost: 0 }]);
  }

  function fpContinueToProposal() {
    setAnalysisResults({
      type: "floorplan",
      devices: editableDevices,
      summary: { totalDevices: editableDevices.reduce((s, d) => s + d.quantity, 0), types: editableDevices.length },
      costRange: [Math.round(fpTotalCostLow), Math.round(fpTotalCostHigh)]
    });
    setPage("generate");
  }

  return (
    <div>
      <StepIndicator steps={["Upload", "Device Placement", "Review & Correct", "Create Proposal"]} currentStep={fpStep} />
    {fpStep === 2 ? (
      /* Step 2: Review & Correct Devices */
      <div style={{ maxWidth: 960 }}>
        <div style={{ fontSize: 14, fontWeight: 600, color: W, marginBottom: 16 }}>Review & Correct Devices — adjust quantities, costs, or remove devices</div>

        {/* Device table */}
        <div style={{ borderRadius: 12, overflow: "hidden", border: `1px solid ${D4}`, marginBottom: 20 }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead><tr style={{ background: D3 }}>
              {["Device", "Label", "Code Reference", "Qty", "Unit Cost", "Line Total", ""].map((h, i) => (
                <th key={i} style={{ ...tableHeaderS, ...(i === 3 ? { width: 70 } : i === 4 ? { width: 100 } : i === 5 ? { width: 110 } : i === 6 ? { width: 40 } : {}) }}>{h}</th>
              ))}
            </tr></thead>
            <tbody>
              {editableDevices.map((d, idx) => {
                const dt = DEVICE_TYPES[d.type];
                return (
                  <tr key={d._id} style={{ background: D2 }}>
                    <td style={tableCellS}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{ fontSize: 16 }}>{dt?.icon || "📍"}</span>
                        <span style={{ fontSize: 13, fontWeight: 500 }}>{d.label}</span>
                      </div>
                    </td>
                    <td style={{ ...tableCellS, fontSize: 12, color: G }}>{d.type.replace(/_/g, " ").toUpperCase().slice(0, 3)}-{idx + 1}</td>
                    <td style={{ ...tableCellS, fontSize: 11, color: G }}>{d.code}</td>
                    <td style={tableCellS}>
                      <input type="number" min="0" style={{ ...inputS, padding: "5px 6px", fontSize: 12, width: 55 }} value={d.quantity} onChange={e => updateDevice(idx, "quantity", parseInt(e.target.value) || 0)} />
                    </td>
                    <td style={tableCellS}>
                      <input type="number" min="0" style={{ ...inputS, padding: "5px 6px", fontSize: 12, width: 85 }} value={d.unitCost} onChange={e => updateDevice(idx, "unitCost", parseFloat(e.target.value) || 0)} />
                    </td>
                    <td style={{ ...tableCellS, fontWeight: 600, color: O }}>${(d.quantity * d.unitCost).toLocaleString()}</td>
                    <td style={tableCellS}>
                      <button onClick={() => removeDevice(idx)} style={{ background: "none", border: "none", color: RD, cursor: "pointer", fontSize: 16 }} title="Remove device">×</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>

        <button onClick={addDevice} style={{ ...btnS(false), width: "100%", marginBottom: 20 }}>+ Add Device</button>

        {/* Cost summary */}
        <div style={{ ...cardS, marginBottom: 20, borderColor: `${O}30` }}>
          <div style={{ fontSize: 11, fontWeight: 700, color: O, textTransform: "uppercase", marginBottom: 8 }}>Equipment Cost Summary</div>
          <div style={{ display: "flex", gap: 20, flexWrap: "wrap" }}>
            <div>
              <div style={{ fontSize: 10, color: G }}>Total Equipment</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: W }}>${Math.round(fpTotalEquipment).toLocaleString()}</div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: G }}>Estimated Range</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: O }}>${Math.round(fpTotalCostLow).toLocaleString()} – ${Math.round(fpTotalCostHigh).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {/* Navigation */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <button onClick={() => setFpStep(1)} style={{ ...btnS(false), padding: "12px 24px" }}>← Back to Device View</button>
          <button onClick={fpContinueToProposal} style={{ ...btnS(true), padding: "14px 32px", fontSize: 15, boxShadow: `0 4px 20px ${O}40` }}>Continue to Proposal →</button>
        </div>
      </div>
    ) : (
    <div style={{ display: "flex", height: "100vh" }}>
      {/* Left - Controls */}
      <div style={{ width: 320, minWidth: 320, background: D2, borderRight: `1px solid ${D4}`, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ padding: "18px 20px", borderBottom: `1px solid ${D4}` }}>
          <h2 style={{ margin: 0, fontSize: 16, fontWeight: 700 }}>🏗️ Floor Plan Markup</h2>
          <p style={{ margin: "4px 0 0", fontSize: 11, color: G }}>NFPA 72 · IFC Chapter 9</p>
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "16px 20px" }}>
          {/* Upload */}
          <label style={labelS}>Upload Floor Plan</label>
          <label style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 20, border: `2px dashed ${image ? GR : D4}`, borderRadius: 10, cursor: "pointer", marginBottom: 16, transition: "all 0.2s", background: image ? `${GR}08` : D3 }}>
            <input type="file" accept="image/*" onChange={handleUpload} style={{ display: "none" }} />
            <span style={{ fontSize: 13, color: image ? GR : G }}>{image ? "✓ Floor plan loaded — click to replace" : "Click to upload PNG, JPG, or PDF"}</span>
          </label>

          {/* Config */}
          <label style={labelS}>Facility Name</label>
          <input style={{ ...inputS, marginBottom: 12 }} placeholder="e.g. Lincoln Elementary" value={facilityName} onChange={e => setFacilityName(e.target.value)} />

          <label style={labelS}>Building Type</label>
          <select style={{ ...inputS, cursor: "pointer", marginBottom: 16 }} value={buildingType} onChange={e => setBuildingType(e.target.value)}>
            {buildingTypes.map(([v, l]) => <option key={v} value={v}>{l}</option>)}
          </select>

          {/* Analyze button */}
          <button onClick={analyzeFloorPlan} disabled={!image || loading} style={{ ...btnS(!loading && !!image), width: "100%", padding: "13px 0", marginBottom: 20, display: "flex", alignItems: "center", justifyContent: "center", gap: 8, boxShadow: loading || !image ? "none" : `0 4px 20px ${O}40` }}>
            {loading ? "⟳ Analyzing per NFPA 72 / IFC Ch.9..." : "🔍 Analyze & Place Devices"}
          </button>

          {error && <div style={{ padding: 12, background: `${RD}18`, borderRadius: 8, color: RD, fontSize: 12, marginBottom: 16 }}>{error}</div>}

          {/* Device filter toggles */}
          {devices.length > 0 && (
            <>
              <label style={labelS}>Device Layers ({filteredDevices.length} / {devices.length} visible)</label>
              <div style={{ display: "flex", flexDirection: "column", gap: 4, marginBottom: 16 }}>
                {usedTypes.map(type => {
                  const dt = DEVICE_TYPES[type];
                  const count = devices.filter(d => d.type === type).length;
                  const active = visibleTypes.includes(type);
                  return (
                    <div key={type} onClick={() => toggleType(type)} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px", borderRadius: 6, cursor: "pointer", background: active ? `${dt.color}15` : D4, border: `1px solid ${active ? dt.color + "40" : "transparent"}`, transition: "all 0.15s", opacity: active ? 1 : 0.5 }}>
                      <div style={{ width: 14, height: 14, borderRadius: "50%", background: dt.color, flexShrink: 0 }} />
                      <span style={{ fontSize: 12, fontWeight: 500, flex: 1 }}>{dt.label}</span>
                      <span style={{ fontSize: 11, color: G }}>{count}</span>
                    </div>
                  );
                })}
              </div>

              {/* Cost estimate */}
              {costEstimate && (
                <div style={{ background: `${O}12`, borderRadius: 10, padding: 14, border: `1px solid ${O}30`, marginBottom: 16 }}>
                  <div style={{ fontSize: 10, fontWeight: 700, color: O, textTransform: "uppercase", marginBottom: 6 }}>Cost Estimate</div>
                  <div style={{ fontSize: 18, fontWeight: 800, color: W }}>${(costEstimate.total_low || 0).toLocaleString()} – ${(costEstimate.total_high || 0).toLocaleString()}</div>
                  <div style={{ fontSize: 11, color: G, marginTop: 4 }}>{costEstimate.description}</div>
                </div>
              )}

              {/* Export */}
              <div style={{ display: "flex", gap: 8 }}>
                <button style={{ ...btnS(true), flex: 1, fontSize: 12 }} onClick={exportMarkup}>📥 Export Marked-Up Plan</button>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginTop: 8 }}>
                <input type="checkbox" checked={showLegend} onChange={e => setShowLegend(e.target.checked)} id="showLegend" />
                <label htmlFor="showLegend" style={{ fontSize: 11, color: G, cursor: "pointer" }}>Include legend in export</label>
              </div>
            </>
          )}
        </div>
      </div>

      {/* Right - Floor Plan Canvas */}
      <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        {/* Header */}
        <div style={{ padding: "12px 24px", borderBottom: `1px solid ${D4}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <span style={{ fontSize: 14, fontWeight: 600 }}>{facilityName || "Floor Plan"}</span>
            {devices.length > 0 && <span style={{ fontSize: 12, color: G, marginLeft: 12 }}>{devices.length} devices placed</span>}
          </div>
          {devices.length > 0 && (
            <div style={{ display: "flex", gap: 6 }}>
              {usedTypes.slice(0, 6).map(type => {
                const dt = DEVICE_TYPES[type];
                const count = devices.filter(d => d.type === type).length;
                return <span key={type} style={{ ...badgeS(dt.color), fontSize: 10 }}>{dt.label.split(" ")[0]} ×{count}</span>;
              })}
              {usedTypes.length > 6 && <span style={{ ...badgeS(G), fontSize: 10 }}>+{usedTypes.length - 6} more</span>}
            </div>
          )}
        </div>

        {/* Canvas area */}
        <div style={{ flex: 1, overflow: "auto", padding: 24, display: "flex", flexDirection: "column", alignItems: "center" }}>
          {!image ? (
            <div style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", color: G }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>🏗️</div>
              <div style={{ fontSize: 16, fontWeight: 600, marginBottom: 8, color: W }}>Upload a Floor Plan</div>
              <div style={{ fontSize: 13, textAlign: "center", maxWidth: 400, lineHeight: 1.6 }}>
                Upload any floor plan image and the AI will analyze it per NFPA 72 and IFC Chapter 9, then mark exactly where every fire alarm, detection, notification, sprinkler, egress, and security device needs to go.
              </div>
            </div>
          ) : (
            <>
              {/* Floor plan with device overlays */}
              <div ref={canvasRef} style={{ position: "relative", display: "inline-block", maxWidth: "100%", borderRadius: 8, overflow: "hidden", border: `1px solid ${D4}`, boxShadow: "0 8px 32px rgba(0,0,0,0.4)" }}>
                <img ref={imgRef} src={image} alt="Floor Plan" style={{ display: "block", maxWidth: "100%", maxHeight: "calc(100vh - 200px)" }} />

                {/* Device markers */}
                {filteredDevices.map((d, i) => {
                  const dt = DEVICE_TYPES[d.type] || DEVICE_TYPES.smoke_detector;
                  return (
                    <div key={i} onClick={() => setSelectedDevice(selectedDevice === i ? null : i)} style={{ position: "absolute", left: `${d.x}%`, top: `${d.y}%`, transform: "translate(-50%, -50%)", cursor: "pointer", zIndex: selectedDevice === i ? 50 : 10 }}>
                      {/* Marker */}
                      <div style={{ width: 24, height: 24, borderRadius: "50%", background: dt.color, border: "2px solid #fff", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 8, fontWeight: 800, color: "#111827", boxShadow: `0 2px 8px ${dt.color}80`, transition: "transform 0.15s", transform: selectedDevice === i ? "scale(1.4)" : "scale(1)" }}>
                        {d.label?.replace(/[^0-9]/g, "") || ""}
                      </div>

                      {/* Tooltip on click */}
                      {selectedDevice === i && (
                        <div style={{ position: "absolute", bottom: "calc(100% + 8px)", left: "50%", transform: "translateX(-50%)", background: D2, border: `1px solid ${D4}`, borderRadius: 8, padding: "10px 14px", minWidth: 220, zIndex: 60, boxShadow: "0 8px 24px rgba(0,0,0,0.5)" }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                            <div style={{ width: 10, height: 10, borderRadius: "50%", background: dt.color }} />
                            <span style={{ fontSize: 12, fontWeight: 700 }}>{d.label} — {dt.label}</span>
                          </div>
                          {d.note && <div style={{ fontSize: 11, color: G, marginBottom: 4 }}>{d.note}</div>}
                          <div style={{ fontSize: 10, color: O, fontWeight: 600 }}>{d.code_ref || dt.code}</div>
                          {/* Arrow */}
                          <div style={{ position: "absolute", bottom: -6, left: "50%", transform: "translateX(-50%) rotate(45deg)", width: 12, height: 12, background: D2, borderRight: `1px solid ${D4}`, borderBottom: `1px solid ${D4}` }} />
                        </div>
                      )}
                    </div>
                  );
                })}

                {/* Loading overlay */}
                {loading && (
                  <div style={{ position: "absolute", inset: 0, background: "rgba(15,15,23,0.85)", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", zIndex: 100 }}>
                    <div style={{ fontSize: 32, marginBottom: 12, animation: "spin 2s linear infinite" }}>🔍</div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: W, marginBottom: 4 }}>Analyzing Floor Plan</div>
                    <div style={{ fontSize: 12, color: G }}>Applying NFPA 72 & IFC Chapter 9 requirements...</div>
                    <style>{`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>
                  </div>
                )}
              </div>

              {/* Analysis panel */}
              {analysis && (
                <div style={{ width: "100%", maxWidth: 900, marginTop: 20 }}>
                  <div style={{ ...cardS, marginBottom: 12 }}>
                    <h4 style={{ margin: "0 0 10px", fontSize: 14, fontWeight: 700, color: O }}>Analysis Summary</h4>
                    <p style={{ margin: 0, fontSize: 13, color: G, lineHeight: 1.7 }}>{analysis}</p>
                  </div>
                  {codeNotes.length > 0 && (
                    <div style={cardS}>
                      <h4 style={{ margin: "0 0 10px", fontSize: 14, fontWeight: 700, color: O }}>Code References Applied</h4>
                      {codeNotes.map((note, i) => (
                        <div key={i} style={{ display: "flex", gap: 8, marginBottom: 8, fontSize: 12, color: G, lineHeight: 1.5 }}>
                          <span style={{ color: O, fontWeight: 700, flexShrink: 0 }}>§</span>
                          <span>{note}</span>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Next: Review Devices button */}
                  {fpStep === 1 && devices.length > 0 && (
                    <div style={{ marginTop: 20, textAlign: "right" }}>
                      <button onClick={() => setFpStep(2)} style={{ ...btnS(true), padding: "12px 28px", fontSize: 14 }}>Next: Review Devices →</button>
                    </div>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
    )}
    </div>
  );
}


// ═══════════════════════════════════════
//  DOCUMENT ANALYSIS PAGE
// ═══════════════════════════════════════
const CHATMAN_CHECKLIST = [
  { section: "Exterior", code: "IFC §503-§509", items: [
    { text: "Fire lanes marked/unobstructed with correct markings", code: "IFC §503.3 / COM §503.3.1", critical: true },
    { text: "Address numbers visible from street", code: "IFC §505.1" },
    { text: "Fire hydrants accessible (3ft clearance)", code: "IFC §507.5.4" },
    { text: "F.D. key box (Knox Box) present, keys current", code: "IFC §506.1" },
    { text: "F.D. connections visible and maintained", code: "IFC §912" },
    { text: "No combustible vegetation endangering property", code: "IFC §304.1.2" },
    { text: "Clear of combustible materials near occupancy", code: "IFC §304.1" },
    { text: "Equipment rooms identified with approved durable signs", code: "IFC §509.1" },
    { text: "Dumpsters min 5ft from buildings", code: "IFC §304.3.3" },
    { text: "Fire apparatus access roads maintained (20ft wide, 13ft 6in clear)", code: "IFC §503.2.1" },
  ]},
  { section: "Egress", code: "IFC Ch.10 / NFPA 101", items: [
    { text: "Exits, aisles, corridors free of obstructions", code: "IFC §1003.6", critical: true },
    { text: "Exit doors open from inside without keys or special knowledge", code: "IFC §1010.1.9" },
    { text: "Exit signs present at every exit", code: "IFC §1013.1", critical: true },
    { text: "Emergency lighting present and operational (90-min backup)", code: "IFC §1008.3", critical: true },
    { text: "Interior finish acceptable", code: "IFC §803" },
    { text: "Accessible route doors operable with closed fist (ADA)", code: "IFC §1010.1.9.2" },
    { text: "Exit door unlatching requires single motion", code: "IFC §1010.1.9.4" },
    { text: "Unlock sign posted where key-operated locking permitted", code: "IFC §1010.1.9.4 Ex.3.2" },
    { text: "Exit signs illuminated and visible from all directions", code: "IFC §1013.3" },
    { text: "Corridor minimum width maintained (44in+)", code: "IFC §1005.1" },
    { text: "Maximum travel distance to exit not exceeded", code: "IFC §1017.1" },
  ]},
  { section: "Construction", code: "IFC Ch.7 / IBC Ch.6", items: [
    { text: "Fire-rated construction present and maintained", code: "IFC §703.1" },
    { text: "Rated fire doors operational (self-closing, positive latching)", code: "IFC §703.2", critical: true },
    { text: "Vertical openings protected", code: "IFC §704.1" },
    { text: "Incidental use areas separated/sprinklered", code: "IBC §508.2.5" },
    { text: "Fire-rated penetrations sealed with approved firestop", code: "IFC §703.4" },
  ]},
  { section: "Storage", code: "IFC Ch.3 & Ch.32", items: [
    { text: "Storage neat, orderly, not creating hazard", code: "IFC §315.3" },
    { text: "No combustible storage in electrical/mechanical rooms", code: "IFC §315.3.3" },
    { text: "Storage 2ft below ceiling (non-sprinklered) or 18in below sprinkler", code: "IFC §315.3.1", critical: true },
    { text: "Decorations flame resistant in assembly occupancies", code: "IFC §806.1" },
  ]},
  { section: "Hazardous Materials", code: "IFC Ch.50-67", items: [
    { text: "Flammable liquids >10gal in approved cabinet", code: "IFC §5704.3.4.1" },
    { text: "Compressed gas cylinders secured", code: "IFC §5303.5" },
    { text: "HazMat rooms/areas properly labeled", code: "IFC §5003.5" },
    { text: "Acceptable quantities with documentation", code: "IFC §5001.5" },
    { text: "Incompatible materials separated", code: "IFC §5003.9.8" },
    { text: "Proper ventilation where required", code: "IFC §5004.3" },
  ]},
  { section: "Electrical", code: "IFC §605 / NFPA 70", items: [
    { text: "No electrical hazards present", code: "IFC §605.1" },
    { text: "Appliances/fixtures in good condition", code: "IFC §605.1" },
    { text: "Extension cords not substituted for fixed wiring", code: "IFC §605.5", critical: true },
    { text: "Power strips properly used (not daisy-chained)", code: "IFC §605.4" },
    { text: "36in clearance at electrical panels", code: "NFPA 70 §110.26(A)", critical: true },
  ]},
  { section: "Fire Extinguishers", code: "IFC §906 / NFPA 10", items: [
    { text: "Extinguishers inspected/maintained annually with current tag", code: "IFC §906.2 / NFPA 10 §7.2", critical: true },
    { text: "Installed at approved locations, max 75ft travel, proper mounting height", code: "IFC §906.3 / NFPA 10 §6.1" },
    { text: "Cabinets identified with approved signs", code: "IFC §906.3.1" },
    { text: "Minimum rating 2-A:10-B:C for light hazard", code: "NFPA 10 §6.2" },
    { text: "Class K within 30ft of commercial cooking", code: "NFPA 10 §6.6" },
  ]},
  { section: "Fire Alarm & Detection", code: "IFC §907 / NFPA 72", items: [
    { text: "Control panel in normal condition (no trouble/alarm)", code: "IFC §907.8.5 / NFPA 72 §14.2.1", critical: true },
    { text: "Detectors unobstructed (not painted, broken, covered)", code: "NFPA 72 §17.7", critical: true },
    { text: "System tested/inspected annually by licensed contractor", code: "IFC §907.8.5 / NFPA 72 §14.3", critical: true },
    { text: "Pull stations accessible at exits", code: "NFPA 72 §17.14" },
    { text: "Notification coverage adequate (audible/visual)", code: "NFPA 72 §18.4" },
    { text: "Monitored by UL-listed central station", code: "NFPA 72 §26.3" },
  ]},
  { section: "Sprinkler System", code: "IFC §903 / NFPA 13/25", items: [
    { text: "Coverage adequate for all areas", code: "IFC §903.3 / NFPA 13", critical: true },
    { text: "Controls accessible and unobstructed", code: "NFPA 25 §13.1" },
    { text: "Valves locked open or electronically supervised", code: "NFPA 25 §13.3.2.1", critical: true },
    { text: "System and valves supervised (tamper switches)", code: "IFC §903.4" },
    { text: "Heads in good condition (no corrosion/paint/damage)", code: "NFPA 25 §5.2.1.1" },
    { text: "Spare heads and wrench present", code: "NFPA 13 §6.2.9" },
    { text: "System inspected per schedule (quarterly/annual/5-year)", code: "NFPA 25 §5.1", critical: true },
    { text: "Riser/pump rooms labeled", code: "IFC §509.1" },
    { text: "No red or yellow impairment tags", code: "NFPA 25 §15.5" },
    { text: "18in clearance below sprinkler deflectors", code: "NFPA 13 §8.5.5" },
    { text: "FDC accessible, caps in place, signage visible", code: "NFPA 13 §9.3" },
  ]},
  { section: "Other Fire Protection", code: "IFC §904 / NFPA 17A/96", items: [
    { text: "Kitchen hood suppression maintained/serviced semi-annually", code: "IFC §904.12.5 / NFPA 17A §7.1", critical: true },
    { text: "Hood system fuel shutoff present and operational", code: "NFPA 96 §10.2" },
    { text: "Standpipes/hose in good condition", code: "IFC §905 / NFPA 25 §6.1" },
    { text: "Fire drills conducted as required", code: "IFC §405" },
    { text: "High-piled storage permit where required (>12ft shelves, >6ft high-hazard)", code: "IFC Ch.32" },
  ]},
  { section: "Security & Access Control", code: "Chatman SOP", items: [
    { text: "Intrusion alarm system operational and monitored", code: "Chatman SOP" },
    { text: "Cameras covering entry/exit, parking, sensitive areas", code: "Chatman SOP" },
    { text: "Access control at main entry points", code: "Chatman SOP" },
    { text: "Visitor management system in place", code: "Chatman SOP" },
    { text: "Emergency lockdown procedures documented", code: "Chatman SOP" },
  ]},
];

const DOC_ANALYSIS_PROMPT = `You are a fire & life safety compliance analyst for Chatman Security & Fire. You analyze uploaded documents (fire marshal checklists, inspection reports, compliance notices, violation letters) and cross-reference them against the Chatman master compliance checklist.

CHATMAN MASTER CHECKLIST:
${JSON.stringify(CHATMAN_CHECKLIST.map(s => ({ section: s.section, code: s.code, items: s.items.map(i => ({ text: i.text, code: i.code, critical: !!i.critical })) })))}

YOUR TASK:
1. Read/OCR the uploaded document carefully
2. Identify what type of document it is (FM checklist, violation notice, inspection report, etc.)
3. For each item in the document, determine if it maps to a Chatman checklist item
4. Identify the status of each item: compliant (✓), deficient (✗), N/A, or unclear
5. Flag any items that are NOT on our checklist (gaps in our coverage)
6. Generate remediation recommendations for deficient items with cost estimates

RESPOND WITH ONLY VALID JSON (no markdown, no backticks):
{
  "document_type": "fire_marshal_checklist",
  "source": "Missouri City Fire & Rescue",
  "findings": [
    {
      "section": "Exterior",
      "item": "Fire lanes marked/unobstructed",
      "status": "deficient",
      "status_on_doc": "marked with dash (deficient)",
      "code_ref": "IFC §503.3",
      "critical": true,
      "note": "Fire lane markings appear to be noted as deficient on the checklist",
      "remediation": "Re-stripe fire lanes with correct markings per COM Amendment §503.3.1",
      "est_cost_low": 800,
      "est_cost_high": 2000
    }
  ],
  "summary": {
    "total_items": 45,
    "compliant": 30,
    "deficient": 8,
    "na": 5,
    "unclear": 2,
    "compliance_pct": 67,
    "critical_deficiencies": 3
  },
  "gaps": ["Items on their checklist not covered by ours"],
  "recommendations": ["Top priority remediation actions"]
}

IMPORTANT: When reading the document, pay close attention to check marks, dashes, X marks, N/A notations, and any handwritten annotations that indicate pass/fail status. A dash (—) typically means deficient/failed. A check (✓) means compliant/passed. N/A means not applicable.`;

function DocAnalysisPage({ inventory, procedures, setAnalysisResults, setPage }) {
  const [images, setImages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState(null);
  const [error, setError] = useState("");
  const [activeTab, setActiveTab] = useState("upload");
  const [checklistView, setChecklistView] = useState("all");
  const [step, setStep] = useState(0); // 0=Upload, 1=Review, 2=Corrections, 3=transition
  const [editableFindings, setEditableFindings] = useState([]);

  function handleUpload(e) {
    const files = Array.from(e.target.files);
    const readers = files.map(file => new Promise((res) => {
      const r = new FileReader();
      r.onload = (ev) => res({ name: file.name, data: ev.target.result, type: file.type });
      r.readAsDataURL(file);
    }));
    Promise.all(readers).then(loaded => {
      setImages(prev => [...prev, ...loaded]);
      setError("");
    });
  }

  function removeImage(idx) {
    setImages(prev => prev.filter((_, i) => i !== idx));
  }

  async function analyzeDocuments() {
    if (!images.length) return;
    setLoading(true);
    setError("");
    setResults(null);

    const invPricing = inventory.map(i => `${i.name} ($${i.unit_cost}/${i.unit})`).join(", ");

    try {
      const content = [];
      for (const img of images) {
        const mediaType = img.data.startsWith("data:image/png") ? "image/png" : "image/jpeg";
        content.push({ type: "image", source: { type: "base64", media_type: mediaType, data: img.data.split(",")[1] } });
      }
      content.push({ type: "text", text: `Analyze these ${images.length} document page(s). This is a fire marshal compliance checklist or inspection document. Read every item carefully, note which items are checked/passed vs. marked deficient/failed vs. N/A. Cross-reference against the Chatman checklist. Use this inventory for cost estimates: ${invPricing}. Respond with ONLY the JSON.` });

      const resp = await fetch("/api/claude", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          system: DOC_ANALYSIS_PROMPT,
          messages: [{ role: "user", content }],
        }),
      });

      const data = await resp.json();
      const text = data.content?.map(b => b.type === "text" ? b.text : "").filter(Boolean).join("\n") || "";
      const cleaned = text.replace(/```json\s*/g, "").replace(/```\s*/g, "").trim();
      const parsed = JSON.parse(cleaned);
      setResults(parsed);
      setActiveTab("results");
      setEditableFindings((parsed.findings || []).map((f, i) => ({ ...f, _id: i })));
      setStep(1);
    } catch (err) {
      setError("Analysis failed: " + err.message + ". Try again.");
    }
    setLoading(false);
  }

  const statusIcon = (s) => {
    if (s === "compliant") return { icon: "✓", color: GR, bg: `${GR}15` };
    if (s === "deficient") return { icon: "✗", color: RD, bg: `${RD}15` };
    if (s === "na") return { icon: "—", color: G, bg: `${G}15` };
    return { icon: "?", color: YL, bg: `${YL}15` };
  };

  const filteredFindings = results?.findings?.filter(f => {
    if (checklistView === "all") return true;
    if (checklistView === "deficient") return f.status === "deficient";
    if (checklistView === "critical") return f.critical && f.status === "deficient";
    return true;
  }) || [];

  const totalRemediation = filteredFindings.reduce((s, f) => ({ low: s.low + (f.est_cost_low || 0), high: s.high + (f.est_cost_high || 0) }), { low: 0, high: 0 });

  // Corrections helpers
  const editableSummary = (() => {
    const def = editableFindings.filter(f => f.status === "deficient").length;
    const comp = editableFindings.filter(f => f.status === "compliant").length;
    const total = editableFindings.length;
    const costLow = editableFindings.reduce((s, f) => s + (f.est_cost_low || 0), 0);
    const costHigh = editableFindings.reduce((s, f) => s + (f.est_cost_high || 0), 0);
    return { deficient: def, compliant: comp, total, compliance_pct: total > 0 ? Math.round((comp / total) * 100) : 0, costLow, costHigh };
  })();

  function updateFinding(idx, field, value) {
    setEditableFindings(prev => prev.map((f, i) => i === idx ? { ...f, [field]: value } : f));
  }

  function removeFinding(idx) {
    setEditableFindings(prev => prev.filter((_, i) => i !== idx));
  }

  function addFinding() {
    setEditableFindings(prev => [...prev, { _id: Date.now(), section: "Other", item: "New finding", status: "deficient", code_ref: "", remediation: "", est_cost_low: 0, est_cost_high: 0, critical: false, note: "" }]);
  }

  function continueToProposal() {
    setAnalysisResults({
      type: "document",
      findings: editableFindings,
      summary: { ...editableSummary, critical_deficiencies: editableFindings.filter(f => f.critical && f.status === "deficient").length },
      costRange: [editableSummary.costLow, editableSummary.costHigh]
    });
    setPage("generate");
  }

  return (
    <div>
      <StepIndicator steps={["Upload", "Review", "Corrections", "Create Proposal"]} currentStep={step} />
    <div style={{ display: "flex", height: "100vh" }}>
      {/* Left panel */}
      <div style={{ width: 340, minWidth: 340, background: D2, borderRight: `1px solid ${D4}`, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ padding: "18px 20px", borderBottom: `1px solid ${D4}` }}>
          <h2 style={{ margin: 0, fontSize: 16, fontWeight: 700 }}>📑 Document Analysis</h2>
          <p style={{ margin: "4px 0 0", fontSize: 11, color: G }}>Upload FM checklists, violations, inspection reports</p>
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "16px 20px" }}>
          {/* Tab buttons */}
          <div style={{ display: "flex", gap: 4, marginBottom: 16 }}>
            {[["upload", "Upload"], ["checklist", "Our Checklist"]].map(([k, l]) => (
              <button key={k} onClick={() => setActiveTab(k)} style={{ flex: 1, padding: "8px 0", borderRadius: 8, border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", background: activeTab === k ? O : D4, color: activeTab === k ? "#fff" : G }}>{l}</button>
            ))}
          </div>

          {activeTab === "upload" && (
            <>
              <label style={labelS}>Upload Document Pages</label>
              <label style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 20, border: `2px dashed ${images.length ? GR : D4}`, borderRadius: 10, cursor: "pointer", marginBottom: 12, background: D3 }}>
                <input type="file" accept="image/*" multiple onChange={handleUpload} style={{ display: "none" }} />
                <span style={{ fontSize: 12, color: G, textAlign: "center" }}>Click to upload checklist pages (multi-select supported)</span>
              </label>

              {images.length > 0 && (
                <div style={{ marginBottom: 16 }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: O, marginBottom: 8 }}>{images.length} page(s) loaded</div>
                  {images.map((img, i) => (
                    <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px", background: D3, borderRadius: 6, marginBottom: 4, border: `1px solid ${D4}` }}>
                      <img src={img.data} alt="" style={{ width: 36, height: 36, objectFit: "cover", borderRadius: 4 }} />
                      <span style={{ fontSize: 11, color: W, flex: 1 }}>{img.name}</span>
                      <button onClick={() => removeImage(i)} style={{ background: "none", border: "none", color: RD, cursor: "pointer", fontSize: 14 }}>×</button>
                    </div>
                  ))}
                </div>
              )}

              <button onClick={analyzeDocuments} disabled={!images.length || loading} style={{ ...btnS(!loading && images.length > 0), width: "100%", padding: "13px 0", marginBottom: 16, boxShadow: loading || !images.length ? "none" : `0 4px 20px ${O}40` }}>
                {loading ? "⟳ Analyzing document..." : "🔍 Analyze Against Checklist"}
              </button>

              {error && <div style={{ padding: 12, background: `${RD}18`, borderRadius: 8, color: RD, fontSize: 12, marginBottom: 12 }}>{error}</div>}

              {/* Results summary card */}
              {results?.summary && (
                <div style={{ background: D3, borderRadius: 10, padding: 14, border: `1px solid ${D4}` }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: O, textTransform: "uppercase", marginBottom: 10 }}>Analysis Summary</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    {[
                      { l: "Total Items", v: results.summary.total_items, c: W },
                      { l: "Compliant", v: results.summary.compliant, c: GR },
                      { l: "Deficient", v: results.summary.deficient, c: RD },
                      { l: "N/A", v: results.summary.na, c: G },
                      { l: "Compliance", v: results.summary.compliance_pct + "%", c: results.summary.compliance_pct >= 80 ? GR : results.summary.compliance_pct >= 60 ? YL : RD },
                      { l: "Critical Issues", v: results.summary.critical_deficiencies, c: RD },
                    ].map((s, i) => (
                      <div key={i} style={{ padding: "8px 10px", background: D4, borderRadius: 6 }}>
                        <div style={{ fontSize: 10, color: G }}>{s.l}</div>
                        <div style={{ fontSize: 18, fontWeight: 800, color: s.c }}>{s.v}</div>
                      </div>
                    ))}
                  </div>
                  {/* Remediation cost */}
                  <div style={{ marginTop: 10, padding: "10px 12px", background: `${O}12`, borderRadius: 8, border: `1px solid ${O}30` }}>
                    <div style={{ fontSize: 10, fontWeight: 700, color: O }}>EST. REMEDIATION COST</div>
                    <div style={{ fontSize: 16, fontWeight: 800, color: W }}>${totalRemediation.low.toLocaleString()} – ${totalRemediation.high.toLocaleString()}</div>
                  </div>
                </div>
              )}
            </>
          )}

          {activeTab === "checklist" && (
            <>
              <div style={{ fontSize: 12, color: G, marginBottom: 12 }}>Chatman Security & Fire master compliance checklist — {CHATMAN_CHECKLIST.reduce((s, sec) => s + sec.items.length, 0)} items across {CHATMAN_CHECKLIST.length} sections</div>
              {CHATMAN_CHECKLIST.map((sec, si) => (
                <div key={si} style={{ marginBottom: 12 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: O, marginBottom: 4 }}>{sec.section}</div>
                  <div style={{ fontSize: 10, color: G, marginBottom: 6 }}>{sec.code}</div>
                  {sec.items.map((item, ii) => (
                    <div key={ii} style={{ display: "flex", gap: 6, padding: "4px 8px", fontSize: 11, color: W, lineHeight: 1.4, marginBottom: 2, background: item.critical ? `${RD}08` : "transparent", borderRadius: 4 }}>
                      <span style={{ color: item.critical ? RD : G, flexShrink: 0 }}>{item.critical ? "⚠" : "☐"}</span>
                      <span>{item.text}</span>
                    </div>
                  ))}
                </div>
              ))}
            </>
          )}
        </div>
      </div>

      {/* Right panel — Results */}
      <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ padding: "12px 24px", borderBottom: `1px solid ${D4}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <span style={{ fontSize: 14, fontWeight: 600 }}>
              {results ? `${results.source || "Document"} — ${results.document_type?.replace(/_/g, " ") || "Analysis"}` : "Analysis Results"}
            </span>
            {results && <span style={{ fontSize: 12, color: G, marginLeft: 12 }}>{results.findings?.length || 0} findings</span>}
          </div>
          {results && (
            <div style={{ display: "flex", gap: 4 }}>
              {[["all", "All"], ["deficient", "Deficient"], ["critical", "Critical"]].map(([k, l]) => (
                <button key={k} onClick={() => setChecklistView(k)} style={{ padding: "5px 12px", borderRadius: 16, border: "none", fontSize: 11, fontWeight: 600, cursor: "pointer", background: checklistView === k ? (k === "critical" ? RD : k === "deficient" ? YL : O) : D4, color: checklistView === k ? "#fff" : G }}>{l} {k !== "all" ? `(${results.findings?.filter(f => k === "deficient" ? f.status === "deficient" : (f.critical && f.status === "deficient")).length || 0})` : ""}</button>
              ))}
            </div>
          )}
        </div>

        <div style={{ flex: 1, overflow: "auto", padding: 24 }}>
          {!results && !loading && (
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100%", color: G }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>📑</div>
              <div style={{ fontSize: 16, fontWeight: 600, color: W, marginBottom: 8 }}>Upload a Document to Analyze</div>
              <div style={{ fontSize: 13, textAlign: "center", maxWidth: 440, lineHeight: 1.6 }}>
                Upload photos of fire marshal checklists, inspection reports, or violation notices. The AI will read every line item, cross-reference it against the Chatman master checklist, and generate a remediation plan with cost estimates from your real inventory.
              </div>
            </div>
          )}

          {loading && (
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "100%", color: G }}>
              <div style={{ fontSize: 32, marginBottom: 12, animation: "spin 2s linear infinite" }}>🔍</div>
              <div style={{ fontSize: 14, fontWeight: 600, color: W }}>Analyzing Document</div>
              <div style={{ fontSize: 12, color: G }}>Reading items, cross-referencing codes, estimating costs...</div>
              <style>{`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>
            </div>
          )}

          {results && (
            <div style={{ maxWidth: 900, margin: "0 auto" }}>
              {/* Findings table */}
              <div style={{ borderRadius: 12, overflow: "hidden", border: `1px solid ${D4}`, marginBottom: 20 }}>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead><tr style={{ background: D3 }}>
                    {["Status", "Section", "Item", "Code", "Remediation", "Est. Cost"].map((h, i) => (
                      <th key={i} style={{ ...tableHeaderS, ...(i === 0 ? { width: 60, textAlign: "center" } : i === 5 ? { width: 110 } : i === 1 ? { width: 90 } : i === 3 ? { width: 100 } : {}) }}>{h}</th>
                    ))}
                  </tr></thead>
                  <tbody>
                    {filteredFindings.map((f, i) => {
                      const si = statusIcon(f.status);
                      return (
                        <tr key={i} style={{ background: f.critical && f.status === "deficient" ? `${RD}08` : D2 }} onMouseEnter={e => e.currentTarget.style.background = D3} onMouseLeave={e => e.currentTarget.style.background = f.critical && f.status === "deficient" ? `${RD}08` : D2}>
                          <td style={{ ...tableCellS, textAlign: "center" }}>
                            <span style={{ display: "inline-flex", alignItems: "center", justifyContent: "center", width: 26, height: 26, borderRadius: "50%", background: si.bg, color: si.color, fontWeight: 800, fontSize: 14 }}>{si.icon}</span>
                          </td>
                          <td style={tableCellS}><span style={badgeS(O)}>{f.section}</span></td>
                          <td style={tableCellS}>
                            <div style={{ fontSize: 12, fontWeight: 500 }}>{f.item}</div>
                            {f.note && <div style={{ fontSize: 11, color: G, marginTop: 2 }}>{f.note}</div>}
                            {f.critical && <span style={{ ...badgeS(RD), fontSize: 9, marginTop: 4, display: "inline-block" }}>CRITICAL</span>}
                          </td>
                          <td style={{ ...tableCellS, fontSize: 11, color: G }}>{f.code_ref}</td>
                          <td style={{ ...tableCellS, fontSize: 12, color: f.status === "deficient" ? W : G }}>{f.remediation || "—"}</td>
                          <td style={{ ...tableCellS, fontWeight: 600, color: f.status === "deficient" ? YL : G, fontSize: 12 }}>
                            {f.est_cost_low ? `$${f.est_cost_low.toLocaleString()}-$${f.est_cost_high.toLocaleString()}` : "—"}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {/* Recommendations */}
              {results.recommendations?.length > 0 && (
                <div style={{ ...cardS, marginBottom: 16 }}>
                  <h4 style={{ margin: "0 0 12px", fontSize: 14, fontWeight: 700, color: O }}>Priority Recommendations</h4>
                  {results.recommendations.map((r, i) => (
                    <div key={i} style={{ display: "flex", gap: 10, marginBottom: 10, fontSize: 13, color: W, lineHeight: 1.5 }}>
                      <span style={{ color: O, fontWeight: 700, flexShrink: 0 }}>{i + 1}.</span>
                      <span>{r}</span>
                    </div>
                  ))}
                </div>
              )}

              {/* Gaps */}
              {results.gaps?.length > 0 && (
                <div style={{ ...cardS, borderColor: `${YL}30` }}>
                  <h4 style={{ margin: "0 0 12px", fontSize: 14, fontWeight: 700, color: YL }}>Coverage Gaps Identified</h4>
                  <div style={{ fontSize: 12, color: G, marginBottom: 8 }}>Items on their checklist not currently in the Chatman master checklist:</div>
                  {results.gaps.map((g, i) => (
                    <div key={i} style={{ display: "flex", gap: 8, marginBottom: 6, fontSize: 12, color: W }}>
                      <span style={{ color: YL }}>⚠</span><span>{g}</span>
                    </div>
                  ))}
                </div>
              )}

              {/* Fee offset */}
              <div style={{ background: `${O}12`, borderRadius: 10, padding: 16, border: `1px solid ${O}30`, marginTop: 16 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: O }}>💰 Consulting Fee Offset</div>
                <div style={{ fontSize: 13, color: G, marginTop: 6, lineHeight: 1.6 }}>
                  Chatman's assessment fee will be credited toward remediation work. Estimated remediation: <strong style={{ color: W }}>${totalRemediation.low.toLocaleString()} – ${totalRemediation.high.toLocaleString()}</strong>
                </div>
              </div>

              {/* Next: Make Corrections button */}
              {step === 1 && (
                <div style={{ marginTop: 20, textAlign: "right" }}>
                  <button onClick={() => setStep(2)} style={{ ...btnS(true), padding: "12px 28px", fontSize: 14 }}>Next: Make Corrections →</button>
                </div>
              )}
            </div>
          )}

          {/* Step 2: Corrections */}
          {step === 2 && results && (
            <div style={{ maxWidth: 960, margin: "0 auto" }}>
              {/* Summary bar */}
              <div style={{ display: "flex", gap: 16, marginBottom: 20, flexWrap: "wrap" }}>
                <div style={{ ...cardS, flex: 1, minWidth: 140, textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: G, textTransform: "uppercase", letterSpacing: 0.5 }}>Total Findings</div>
                  <div style={{ fontSize: 22, fontWeight: 800, color: W }}>{editableSummary.total}</div>
                </div>
                <div style={{ ...cardS, flex: 1, minWidth: 140, textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: G, textTransform: "uppercase", letterSpacing: 0.5 }}>Deficient</div>
                  <div style={{ fontSize: 22, fontWeight: 800, color: RD }}>{editableSummary.deficient}</div>
                </div>
                <div style={{ ...cardS, flex: 1, minWidth: 140, textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: G, textTransform: "uppercase", letterSpacing: 0.5 }}>Compliance</div>
                  <div style={{ fontSize: 22, fontWeight: 800, color: editableSummary.compliance_pct >= 80 ? GR : editableSummary.compliance_pct >= 60 ? YL : RD }}>{editableSummary.compliance_pct}%</div>
                </div>
                <div style={{ ...cardS, flex: 1, minWidth: 140, textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: G, textTransform: "uppercase", letterSpacing: 0.5 }}>Est. Cost Range</div>
                  <div style={{ fontSize: 16, fontWeight: 800, color: O }}>${editableSummary.costLow.toLocaleString()} – ${editableSummary.costHigh.toLocaleString()}</div>
                </div>
              </div>

              <div style={{ fontSize: 14, fontWeight: 600, color: W, marginBottom: 12 }}>Edit Findings — adjust status, costs, or remove irrelevant items</div>

              {editableFindings.map((f, idx) => (
                <div key={f._id} style={{ ...cardS, marginBottom: 10, padding: 16 }}>
                  <div style={{ display: "flex", gap: 12, alignItems: "flex-start", flexWrap: "wrap" }}>
                    {/* Section + item */}
                    <div style={{ flex: 2, minWidth: 200 }}>
                      <div style={{ fontSize: 11, color: O, fontWeight: 600, marginBottom: 2 }}>{f.section}</div>
                      <div style={{ fontSize: 13, fontWeight: 500, color: W }}>{f.item}</div>
                      {f.note && <div style={{ fontSize: 11, color: G, marginTop: 2 }}>{f.note}</div>}
                    </div>

                    {/* Status dropdown */}
                    <div style={{ minWidth: 130 }}>
                      <label style={{ fontSize: 10, color: G, display: "block", marginBottom: 2 }}>Status</label>
                      <select style={{ ...inputS, padding: "6px 8px", fontSize: 12 }} value={f.status} onChange={e => updateFinding(idx, "status", e.target.value)}>
                        <option value="compliant">Compliant</option>
                        <option value="deficient">Deficient</option>
                        <option value="na">N/A</option>
                        <option value="unclear">Unclear</option>
                      </select>
                    </div>

                    {/* Code ref (read-only) */}
                    <div style={{ minWidth: 120 }}>
                      <label style={{ fontSize: 10, color: G, display: "block", marginBottom: 2 }}>Code Ref</label>
                      <div style={{ fontSize: 12, color: G, padding: "7px 0" }}>{f.code_ref || "—"}</div>
                    </div>

                    {/* Cost inputs */}
                    <div style={{ display: "flex", gap: 8, minWidth: 180 }}>
                      <div>
                        <label style={{ fontSize: 10, color: G, display: "block", marginBottom: 2 }}>Cost Low</label>
                        <input type="number" style={{ ...inputS, padding: "6px 8px", fontSize: 12, width: 80 }} value={f.est_cost_low || 0} onChange={e => updateFinding(idx, "est_cost_low", parseInt(e.target.value) || 0)} />
                      </div>
                      <div>
                        <label style={{ fontSize: 10, color: G, display: "block", marginBottom: 2 }}>Cost High</label>
                        <input type="number" style={{ ...inputS, padding: "6px 8px", fontSize: 12, width: 80 }} value={f.est_cost_high || 0} onChange={e => updateFinding(idx, "est_cost_high", parseInt(e.target.value) || 0)} />
                      </div>
                    </div>

                    {/* Delete button */}
                    <div style={{ display: "flex", alignItems: "center", paddingTop: 14 }}>
                      <button onClick={() => removeFinding(idx)} style={{ background: "none", border: "none", color: RD, cursor: "pointer", fontSize: 18, padding: 4 }} title="Remove finding">×</button>
                    </div>
                  </div>

                  {/* Remediation notes */}
                  <div style={{ marginTop: 8 }}>
                    <label style={{ fontSize: 10, color: G, display: "block", marginBottom: 2 }}>Remediation Notes</label>
                    <textarea style={{ ...inputS, minHeight: 36, resize: "vertical", fontSize: 12 }} value={f.remediation || ""} onChange={e => updateFinding(idx, "remediation", e.target.value)} placeholder="Remediation notes..." />
                  </div>
                </div>
              ))}

              {/* Add Finding button */}
              <button onClick={addFinding} style={{ ...btnS(false), width: "100%", marginTop: 8, marginBottom: 20 }}>+ Add Finding</button>

              {/* Continue to Proposal button */}
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 8, marginBottom: 20 }}>
                <button onClick={() => setStep(1)} style={{ ...btnS(false), padding: "12px 24px" }}>← Back to Review</button>
                <button onClick={continueToProposal} style={{ ...btnS(true), padding: "14px 32px", fontSize: 15, boxShadow: `0 4px 20px ${O}40` }}>Continue to Proposal →</button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  GENERATE PROPOSAL PAGE
// ═══════════════════════════════════════
function GeneratePage({ inventory, procedures, clients, proposals, setProposals, setClients, analysisResults, setAnalysisResults }) {
  const [selectedClient, setSelectedClient] = useState("");
  const [newClient, setNewClient] = useState(false);
  const [clientForm, setClientForm] = useState({ name: "", contact_name: "", contact_title: "", contact_email: "", org_type: "school_district", num_facilities: "", address: "", notes: "" });
  const [tier, setTier] = useState("3");
  const initialMsg = analysisResults
    ? (analysisResults.type === "document"
      ? `Analysis results loaded: Document Analysis with ${analysisResults.findings?.length || 0} findings (${analysisResults.summary?.deficient || 0} deficiencies, ${analysisResults.summary?.compliance_pct || "N/A"}% compliance). Estimated remediation: $${analysisResults.costRange?.[0]?.toLocaleString() || 0} – $${analysisResults.costRange?.[1]?.toLocaleString() || 0}.\n\nI have full access to your inventory (${inventory.length} items), procedures (${procedures.length} SOPs), and client records. Select or add a client on the left to build a proposal incorporating these findings.`
      : `Analysis results loaded: Floor Plan Analysis with ${analysisResults.devices?.length || 0} device types (${analysisResults.summary?.totalDevices || 0} total devices). Estimated equipment cost: $${analysisResults.costRange?.[0]?.toLocaleString() || 0} – $${analysisResults.costRange?.[1]?.toLocaleString() || 0}.\n\nI have full access to your inventory (${inventory.length} items), procedures (${procedures.length} SOPs), and client records. Select or add a client on the left to build a proposal incorporating these device placements.`)
    : "Ready to build a proposal. Select or add a client on the left, then tell me about the opportunity. I have full access to your inventory (" + inventory.length + " items), procedures (" + procedures.length + " SOPs), and client records.";
  const [messages, setMessages] = useState([{ role: "assistant", content: initialMsg }]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [generating, setGenerating] = useState(false);
  const chatEndRef = useRef(null);
  const inputRef = useRef(null);

  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

  const client = clients.find(c => c.id === selectedClient);
  const numFac = client?.num_facilities || clientForm.num_facilities || 1;
  const pricing = calcPrice(numFac);

  function calcPrice(n) {
    n = parseInt(n) || 1;
    if (n >= 40) return { t1: [150000, 175000], t2: [175000, 225000], t3: [225000, 275000] };
    if (n >= 20) { const b = n * 2800; return { t1: [Math.round(b * .9), Math.round(b * 1.1)], t2: [Math.round(b * 1.15), Math.round(b * 1.4)], t3: [Math.round(b * 1.45), Math.round(b * 1.75)] }; }
    if (n >= 5) { const b = n * 3200; return { t1: [Math.round(b * .9), Math.round(b * 1.1)], t2: [Math.round(b * 1.15), Math.round(b * 1.4)], t3: [Math.round(b * 1.45), Math.round(b * 1.75)] }; }
    const b = n * 3500; return { t1: [Math.round(b * .85), Math.round(b * 1.15)], t2: [Math.round(b * 1.2), Math.round(b * 1.5)], t3: [Math.round(b * 1.5), Math.round(b * 1.85)] };
  }

  const fmt = n => "$" + n.toLocaleString();
  const tierOpts = [
    { v: "1", l: "Tier 1 — Assessment Only", r: pricing.t1 },
    { v: "2", l: "Tier 2 — Assessment + Coordination", r: pricing.t2 },
    { v: "3", l: "Tier 3 — Full Service", r: pricing.t3 },
  ];

  function buildSystemPrompt() {
    const invSummary = CATEGORIES.map(cat => {
      const items = inventory.filter(i => i.category === cat);
      if (!items.length) return null;
      return `${cat}: ${items.map(i => `${i.name} ($${i.unit_cost}/${i.unit})`).join(", ")}`;
    }).filter(Boolean).join("\n");

    const procSummary = procedures.map(p => `${p.name} [${p.category}]: ${p.steps.split("\n").length} steps`).join("\n");

    const clientInfo = client ? `CURRENT CLIENT: ${client.name}, Contact: ${client.contact_name} (${client.contact_title}), Type: ${client.org_type}, Facilities: ${client.num_facilities}, Notes: ${client.notes}` : newClient ? `NEW CLIENT: ${clientForm.name}, Facilities: ${clientForm.num_facilities}` : "No client selected yet";

    return `You are the Chatman Security & Fire proposal assistant. You help Howard generate proposals using REAL company data from the database.

COMPANY: Chatman Security & Fire, Houston TX. Fire & life safety compliance consulting.
KEY DIFFERENTIATOR: Consulting Fee Offset — fees credited toward remediation work.

${clientInfo}

SELECTED TIER: ${tier} | PRICING: Tier 1 ${fmt(pricing.t1[0])}-${fmt(pricing.t1[1])}, Tier 2 ${fmt(pricing.t2[0])}-${fmt(pricing.t2[1])}, Tier 3 ${fmt(pricing.t3[0])}-${fmt(pricing.t3[1])}+

REAL INVENTORY (${inventory.length} items):
${invSummary}

PROCEDURES (${procedures.length} SOPs):
${procSummary}

FULL PROCEDURE DETAILS:
${procedures.map(p => `--- ${p.name} ---\n${p.steps}\nNotes: ${p.notes}`).join("\n\n")}

PROPOSAL STRUCTURE: 6 phases — Initial Consultation, On-Site Assessment, Reporting, Fire Marshal Coordination, Cost Estimation, Remediation Oversight.

When helping with proposals, reference ACTUAL inventory items and pricing from the database. Reference actual procedures by name. Be concise and direct.` + (analysisResults ? (
      analysisResults.type === "document"
        ? `\n\nPREVIOUS ANALYSIS RESULTS:\nDocument analysis found ${analysisResults.findings?.length || 0} items. ${analysisResults.summary?.deficient || 0} deficiencies found. Compliance: ${analysisResults.summary?.compliance_pct || 'N/A'}%. Estimated remediation cost: $${analysisResults.costRange?.[0]?.toLocaleString()} - $${analysisResults.costRange?.[1]?.toLocaleString()}.\n\nDeficient items:\n${analysisResults.findings?.filter(f => f.status === 'deficient').map(f => `- ${f.item} (${f.code_ref}) - Est: $${f.est_cost_low}-$${f.est_cost_high}`).join('\n') || 'None'}`
        : `\n\nPREVIOUS ANALYSIS RESULTS:\nFloor plan analysis identified ${analysisResults.devices?.length || 0} device placements per NFPA 72 / IFC Ch.9.\n\nDevices:\n${analysisResults.devices?.map(d => `- ${d.label}: ${d.quantity}x @ $${d.unitCost} = $${d.quantity * d.unitCost}`).join('\n') || 'None'}\n\nTotal equipment estimate: $${analysisResults.costRange?.[0]?.toLocaleString()} - $${analysisResults.costRange?.[1]?.toLocaleString()}`
    ) : '');
  }

  async function sendMessage() {
    if (!input.trim() || loading) return;
    const userMsg = input.trim();
    setInput("");
    setMessages(prev => [...prev, { role: "user", content: userMsg }]);
    setLoading(true);
    try {
      const history = messages.map(m => ({ role: m.role, content: m.content }));
      history.push({ role: "user", content: userMsg });
      const resp = await fetch("/api/claude", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1000, system: buildSystemPrompt(), messages: history }),
      });
      const data = await resp.json();
      const reply = data.content?.map(b => b.type === "text" ? b.text : "").filter(Boolean).join("\n") || "Error processing. Try again.";
      setMessages(prev => [...prev, { role: "assistant", content: reply }]);
    } catch {
      setMessages(prev => [...prev, { role: "assistant", content: "Connection error. Try again." }]);
    }
    setLoading(false);
  }

  async function handleGenerate() {
    const name = client?.name || clientForm.name;
    if (!name) { alert("Select or add a client first."); return; }

    // If new client, save them
    let clientId = selectedClient;
    if (newClient && clientForm.name) {
      const newCl = { ...clientForm, id: uid(), created_at: new Date().toISOString() };
      setClients(prev => [...prev, newCl]);
      fetch("/api/proposal-agent/clients", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newCl) }).catch(console.error);
      clientId = newCl.id;
      setSelectedClient(newCl.id);
      setNewClient(false);
    }

    setGenerating(true);
    try {
      if (!window.jspdf) {
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js";
        document.head.appendChild(script);
        await new Promise(res => script.onload = res);
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "letter" });
      const PW = 612, PH = 792, M = 54, CW = PW - M * 2;
      let y = 0;

      const cName = client?.name || clientForm.name;
      const cContact = client?.contact_name || clientForm.contact_name;
      const cTitle = client?.contact_title || clientForm.contact_title;
      const nFac = client?.num_facilities || clientForm.num_facilities || "TBD";
      const p = pricing;
      const tierNames = { "1": "Assessment Only", "2": "Assessment + Fire Marshal Coordination", "3": "Full Service (Recommended)" };

      function addPage() { doc.addPage(); y = M; }
      function orangeLine(yp) { doc.setDrawColor(232,119,34); doc.setLineWidth(3); doc.line(M, yp, PW - M, yp); }
      function sectionTitle(text) {
        if (y > PH - 120) addPage();
        y += 28; doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.setTextColor(232,119,34);
        doc.text(text, M, y); y += 8; orangeLine(y); y += 20;
      }
      function body(text, opts = {}) {
        doc.setFont("helvetica","normal"); doc.setFontSize(opts.size || 11); doc.setTextColor(51,51,51);
        const lines = doc.splitTextToSize(text, CW);
        for (const line of lines) { if (y > PH - 60) addPage(); doc.text(line, M, y); y += 17; }
        y += 4;
      }
      function bold(text) {
        doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(51,51,51);
        const lines = doc.splitTextToSize(text, CW);
        for (const line of lines) { if (y > PH - 60) addPage(); doc.text(line, M, y); y += 17; }
        y += 4;
      }
      function bullet(text) {
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        const lines = doc.splitTextToSize(text, CW - 20);
        for (let i = 0; i < lines.length; i++) {
          if (y > PH - 60) addPage();
          if (i === 0) { doc.setTextColor(232,119,34); doc.text("•", M + 4, y); }
          doc.setTextColor(51,51,51); doc.text(lines[i], M + 20, y); y += 17;
        }
      }

      // Cover
      doc.setFillColor(232,119,34); doc.rect(0,0,PW,8,"F");
      try { doc.addImage(LOGO_URI, "PNG", M, 30, 80, 80); } catch{}
      doc.setFont("helvetica","bold"); doc.setFontSize(28); doc.setTextColor(232,119,34); doc.text("CHATMAN", M+95, 62);
      doc.setTextColor(80,80,80); doc.text("SECURITY & FIRE", M+95, 96);
      orangeLine(130);
      doc.setFont("helvetica","bold"); doc.setFontSize(22); doc.setTextColor(51,51,51);
      doc.text("Fire & Life Safety", M, 180); doc.text("Compliance Consulting Proposal", M, 210);
      doc.setFont("helvetica","normal"); doc.setFontSize(14); doc.setTextColor(120,120,120);
      doc.text("Prepared for:", M, 260);
      doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.setTextColor(51,51,51);
      doc.text(cName, M, 286);
      if (cContact) { doc.setFont("helvetica","normal"); doc.setFontSize(12); doc.setTextColor(100,100,100); doc.text(`Attn: ${cContact}${cTitle ? ", " + cTitle : ""}`, M, 310); }
      const dateStr = new Date().toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" });
      doc.setFont("helvetica","normal"); doc.setFontSize(12); doc.setTextColor(120,120,120);
      doc.text(`Date: ${dateStr}`, M, 350); doc.text(`Facilities: ${nFac}`, M, 370);
      doc.text(`Recommended Tier: Tier ${tier} — ${tierNames[tier]}`, M, 390);
      doc.setFillColor(80,80,80); doc.rect(0, PH-60, PW, 60, "F");
      doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(255,255,255);
      doc.text("Chatman Security & Fire  |  Houston, TX  |  chatmansecurityandfire.com", M, PH-30);

      // Exec Summary
      addPage();
      sectionTitle("1. Executive Summary");
      body(`Chatman Security & Fire is pleased to present this proposal for comprehensive fire and life safety compliance consulting services for ${cName}. With ${nFac} facilities requiring assessment, our team will deliver a systematic approach to identifying compliance gaps, coordinating with the Fire Marshal's office, and providing a clear roadmap to full compliance.`);
      body("Our consulting fee offset means your assessment investment can be credited toward remediation work — making Chatman the obvious choice for the full project lifecycle.");

      // Scope
      sectionTitle("2. Scope of Services");
      procedures.forEach(proc => {
        if (y > PH - 140) addPage();
        bold(proc.name);
        proc.steps.split("\n").forEach(step => { if (step.trim()) bullet(step.trim()); });
        if (proc.notes) { doc.setFont("helvetica","italic"); doc.setFontSize(10); doc.setTextColor(120,120,120); body("Note: " + proc.notes, { size: 10 }); }
        y += 8;
      });

      // Pricing
      addPage();
      sectionTitle("3. Investment & Pricing");
      body("We offer three engagement tiers:"); y += 8;
      const tiers = [
        { t: "Tier 1", n: "Assessment Only", r: p.t1, d: "Full compliance audit, individual reports, master compliance summary" },
        { t: "Tier 2", n: "Assessment + Coordination", r: p.t2, d: "Tier 1 + Fire Marshal liaison, inspection attendance, timeline management" },
        { t: "Tier 3", n: "Full Service (Recommended)", r: p.t3, d: "Tier 2 + full remediation project management with consulting fee offset" },
      ];
      tiers.forEach(t => {
        if (y > PH - 100) addPage();
        const sel = t.t.includes(tier);
        if (sel) { doc.setFillColor(254,243,232); doc.roundedRect(M-4, y-14, CW+8, 70, 4, 4, "F"); }
        doc.setFont("helvetica","bold"); doc.setFontSize(13); doc.setTextColor(232,119,34);
        doc.text(`${t.t} — ${t.n}`, M+4, y); y += 18;
        doc.setFontSize(14); doc.setTextColor(51,51,51);
        doc.text(`${fmt(t.r[0])} – ${fmt(t.r[1])}${t.t === "Tier 3" ? "+" : ""}`, M+4, y); y += 18;
        doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(100,100,100);
        doc.text(t.d, M+4, y); y += 28;
      });

      // Equipment reference
      y += 10; if (y > PH - 100) addPage();
      sectionTitle("4. Equipment & Pricing Reference");
      body("The following equipment and service pricing is based on our current inventory and will be applied to the remediation cost estimate:");
      y += 4;
      CATEGORIES.forEach(cat => {
        const items = inventory.filter(i => i.category === cat);
        if (!items.length) return;
        if (y > PH - 80) addPage();
        bold(cat);
        items.forEach(item => bullet(`${item.name}: $${item.unit_cost.toLocaleString()} ${item.unit} — ${item.description}`));
        y += 6;
      });

      // Timeline
      if (y > PH - 180) addPage();
      sectionTitle("5. Proposed Timeline");
      [["Weeks 1–2", "Document review, consultation, scheduling"], ["Weeks 3–8", `On-site assessments across all ${nFac} facilities`], ["Weeks 9–10", "Report compilation, cost estimation"], ["Weeks 11–12", "Findings presentation, Fire Marshal coordination"]].forEach(([wk, desc]) => {
        if (y > PH - 60) addPage();
        doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(232,119,34); doc.text(wk, M, y);
        doc.setFont("helvetica","normal"); doc.setTextColor(80,80,80); doc.text(desc, M+90, y); y += 22;
      });

      // Terms + signatures
      y += 20; if (y > PH - 200) addPage();
      sectionTitle("6. Terms & Conditions");
      ["Proposal valid 60 days from date of issue.", "30% deposit required to initiate services.", "Payment terms: Net 30.", "Chatman Security & Fire maintains full liability insurance and bonding.", `Consulting fee offset applies when ${cName} awards remediation work within 12 months.`].forEach(t => bullet(t));
      y += 30; if (y > PH - 120) addPage();
      doc.setDrawColor(200,200,200); doc.setLineWidth(.5); doc.line(M, y, PW-M, y); y += 24;
      doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(51,51,51); doc.text("AUTHORIZED BY:", M, y); y += 30;
      doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(120,120,120);
      doc.text("____________________________________", M, y); doc.text(`${cContact || "Authorized Rep"}, ${cName}`, M, y+16);
      doc.text("____________________________________", PW/2+20, y); doc.text("Howard Chatman, Chatman Security & Fire", PW/2+20, y+16);

      // Page footers
      const pc = doc.internal.getNumberOfPages();
      for (let i = 2; i <= pc; i++) {
        doc.setPage(i); doc.setFillColor(245,245,245); doc.rect(0,PH-40,PW,40,"F");
        doc.setDrawColor(232,119,34); doc.setLineWidth(2); doc.line(0,PH-40,PW,PH-40);
        doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(150,150,150);
        doc.text("Chatman Security & Fire  |  Houston, TX  |  chatmansecurityandfire.com", M, PH-18);
        doc.text(`Page ${i-1} of ${pc-1}`, PW-M-50, PH-18);
      }

      const fn = `Chatman_Proposal_${cName.replace(/[^a-zA-Z0-9]/g,"_")}_${new Date().toISOString().slice(0,10)}.pdf`;
      doc.save(fn);

      // Save to history
      const pr = pricing[`t${tier}`] || pricing.t3;
      const newProposal = { id: uid(), client_id: clientId, client_name: cName, tier, status: "draft", total_low: pr[0], total_high: pr[1], created_at: new Date().toISOString(), filename: fn };
      setProposals(prev => [...prev, newProposal]);
      fetch("/api/proposal-agent/proposals", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newProposal) }).catch(console.error);
      setMessages(prev => [...prev, { role: "assistant", content: `✅ Proposal generated and downloaded as ${fn}. It includes your real inventory pricing (${inventory.length} items) and all ${procedures.length} SOPs. Saved to proposal history as draft.` }]);
    } catch (err) {
      setMessages(prev => [...prev, { role: "assistant", content: `Error: ${err.message}` }]);
    }
    setGenerating(false);
  }

  const ucf = (k, v) => setClientForm(p => ({ ...p, [k]: v }));

  return (
    <div style={{ display: "flex", height: "calc(100vh)" }}>
      {/* Left - Config */}
      <div style={{ width: 360, minWidth: 360, background: D2, borderRight: `1px solid ${D4}`, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ padding: "18px 20px", borderBottom: `1px solid ${D4}` }}>
          <h2 style={{ margin: 0, fontSize: 16, fontWeight: 700 }}>Proposal Setup</h2>
        </div>
        <div style={{ flex: 1, overflow: "auto", padding: "16px 20px" }}>
          {/* Client Selection */}
          <label style={labelS}>Client</label>
          {!newClient ? (
            <div style={{ marginBottom: 14 }}>
              <select style={{ ...inputS, cursor: "pointer", marginBottom: 8 }} value={selectedClient} onChange={e => setSelectedClient(e.target.value)}>
                <option value="">— Select existing client —</option>
                {clients.map(c => <option key={c.id} value={c.id}>{c.name} ({c.num_facilities || "?"} facilities)</option>)}
              </select>
              <button style={{ ...btnS(false), width: "100%", fontSize: 12 }} onClick={() => setNewClient(true)}>+ New Client</button>
            </div>
          ) : (
            <div style={{ marginBottom: 14, padding: 14, background: D3, borderRadius: 10, border: `1px solid ${D4}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 10 }}>
                <span style={{ fontSize: 12, fontWeight: 600, color: O }}>New Client</span>
                <button style={{ background: "none", border: "none", color: G, cursor: "pointer", fontSize: 11 }} onClick={() => setNewClient(false)}>Cancel</button>
              </div>
              <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                <input style={inputS} placeholder="Organization name" value={clientForm.name} onChange={e => ucf("name", e.target.value)} />
                <input style={inputS} placeholder="Contact name" value={clientForm.contact_name} onChange={e => ucf("contact_name", e.target.value)} />
                <input style={inputS} placeholder="Contact title" value={clientForm.contact_title} onChange={e => ucf("contact_title", e.target.value)} />
                <input style={inputS} placeholder="# of facilities" type="number" value={clientForm.num_facilities} onChange={e => ucf("num_facilities", e.target.value)} />
              </div>
            </div>
          )}

          {/* Tier */}
          <label style={{ ...labelS, marginTop: 8 }}>Service Tier</label>
          {tierOpts.map(t => (
            <div key={t.v} onClick={() => setTier(t.v)} style={{ padding: "10px 12px", marginBottom: 6, borderRadius: 8, cursor: "pointer", background: tier === t.v ? `${O}18` : D4, border: `1.5px solid ${tier === t.v ? O : "rgba(255,255,255,0.06)"}` }}>
              <div style={{ fontSize: 12, fontWeight: 600, color: tier === t.v ? O : W }}>{t.l}</div>
              <div style={{ fontSize: 14, fontWeight: 700, color: W, marginTop: 2 }}>{fmt(t.r[0])} – {fmt(t.r[1])}{t.v === "3" ? "+" : ""}</div>
            </div>
          ))}

          <div style={{ background: `${O}12`, borderRadius: 10, padding: 12, border: `1px solid ${O}30`, marginTop: 12 }}>
            <div style={{ fontSize: 10, fontWeight: 600, color: O, textTransform: "uppercase" }}>Fee Offset Reminder</div>
            <div style={{ fontSize: 12, color: G, marginTop: 4 }}>Consulting fees credited toward remediation work</div>
          </div>
        </div>
        <div style={{ padding: "14px 20px", borderTop: `1px solid ${D4}` }}>
          <button onClick={handleGenerate} disabled={generating} style={{ ...btnS(!generating), width: "100%", padding: "13px 0", boxShadow: generating ? "none" : `0 4px 20px ${O}40`, display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}>
            {generating ? "⟳ Generating..." : "📄 Generate Proposal PDF"}
          </button>
        </div>
      </div>

      {/* Right - Chat */}
      <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden" }}>
        <div style={{ padding: "14px 24px", borderBottom: `1px solid ${D4}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <h2 style={{ margin: 0, fontSize: 15, fontWeight: 700 }}>AI Assistant</h2>
            <span style={{ fontSize: 11, color: G }}>Database-connected · {inventory.length} items · {procedures.length} SOPs</span>
          </div>
          {(client || clientForm.name) && <span style={{ padding: "4px 12px", background: `${O}18`, borderRadius: 20, fontSize: 11, color: O, fontWeight: 600 }}>{client?.name || clientForm.name}</span>}
        </div>
        {/* Analysis Results Banner */}
        {analysisResults && (
          <div style={{ padding: "10px 24px", background: `${analysisResults.type === "document" ? O : BL}10`, borderBottom: `1px solid ${analysisResults.type === "document" ? O : BL}30`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div style={{ fontSize: 13, color: W }}>
              <span style={{ fontWeight: 600 }}>{analysisResults.type === "document" ? "📝 Document Analysis" : "🏗️ Floor Plan Analysis"}</span>
              <span style={{ color: G, marginLeft: 8 }}>
                {analysisResults.type === "document"
                  ? `${analysisResults.findings?.length || 0} findings · ${analysisResults.summary?.deficient || 0} deficiencies · Est. $${analysisResults.costRange?.[0]?.toLocaleString()} – $${analysisResults.costRange?.[1]?.toLocaleString()}`
                  : `${analysisResults.summary?.totalDevices || 0} devices · ${analysisResults.devices?.length || 0} types · Est. $${analysisResults.costRange?.[0]?.toLocaleString()} – $${analysisResults.costRange?.[1]?.toLocaleString()}`
                }
              </span>
            </div>
            <button onClick={() => setAnalysisResults(null)} style={{ background: "none", border: "none", color: G, cursor: "pointer", fontSize: 16, padding: "2px 6px" }} title="Dismiss">×</button>
          </div>
        )}
        <div style={{ flex: 1, overflow: "auto", padding: "16px 24px" }}>
          {messages.map((msg, i) => (
            <div key={i} style={{ marginBottom: 14, display: "flex", gap: 10, justifyContent: msg.role === "user" ? "flex-end" : "flex-start" }}>
              {msg.role === "assistant" && <img src={LOGO_URI} alt="" style={{ width: 28, height: 28, borderRadius: 6, objectFit: "cover", flexShrink: 0, marginTop: 2 }} />}
              <div style={{ maxWidth: "75%", padding: "10px 14px", borderRadius: 12, background: msg.role === "user" ? O : D3, color: "#111827", fontSize: 13, lineHeight: 1.6, whiteSpace: "pre-wrap", borderTopLeftRadius: msg.role === "assistant" ? 3 : 12, borderTopRightRadius: msg.role === "user" ? 3 : 12 }}>
                {msg.content}
              </div>
            </div>
          ))}
          {loading && <div style={{ display: "flex", gap: 10, marginBottom: 14 }}><img src={LOGO_URI} alt="" style={{ width: 28, height: 28, borderRadius: 6, objectFit: "cover" }} /><div style={{ padding: "10px 14px", background: D3, borderRadius: "3px 12px 12px 12px", fontSize: 13, color: G }}>Thinking...</div></div>}
          <div ref={chatEndRef} />
        </div>
        <div style={{ padding: "14px 24px", borderTop: `1px solid ${D4}` }}>
          <div style={{ display: "flex", gap: 8 }}>
            <input ref={inputRef} value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === "Enter" && sendMessage()} placeholder="Ask about pricing, scope, inventory, procedures..." style={{ ...inputS, flex: 1 }} />
            <button onClick={sendMessage} disabled={loading || !input.trim()} style={btnS(!!input.trim())}>Send</button>
          </div>
          <div style={{ display: "flex", gap: 6, marginTop: 8, flexWrap: "wrap" }}>
            {["What equipment for this client?", "Draft executive summary", "Estimate remediation cost", "Which tier do you recommend?"].map((q, i) => (
              <button key={i} onClick={() => { setInput(q); inputRef.current?.focus(); }} style={{ padding: "4px 10px", background: D4, border: `1px solid rgba(255,255,255,0.06)`, borderRadius: 16, color: G, fontSize: 11, cursor: "pointer" }}>{q}</button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
//  PROPOSAL HISTORY
// ═══════════════════════════════════════
function HistoryPage({ proposals, setProposals, clients }) {
  async function updateStatus(id, status) {
    setProposals(prev => prev.map(p => p.id === id ? { ...p, status } : p));
    fetch("/api/proposal-agent/proposals", { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, status }) }).catch(console.error);
  }

  return (
    <div>
      <PageHeader title="Proposal History" subtitle={`${proposals.length} proposals generated`} />
      <div style={{ padding: "20px 32px" }}>
        {proposals.length === 0 ? (
          <div style={{ ...cardS, textAlign: "center", padding: 60 }}>
            <div style={{ fontSize: 32, marginBottom: 12 }}>📄</div>
            <div style={{ fontSize: 15, fontWeight: 600 }}>No proposals yet</div>
            <div style={{ fontSize: 13, color: G }}>Generated proposals will appear here with status tracking</div>
          </div>
        ) : (
          <div style={{ borderRadius: 12, overflow: "hidden", border: `1px solid ${D4}` }}>
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead><tr style={{ background: D3 }}>
                {["Client", "Tier", "Range", "Date", "Status", ""].map((h, i) => <th key={i} style={tableHeaderS}>{h}</th>)}
              </tr></thead>
              <tbody>
                {[...proposals].reverse().map(p => {
                  const cl = clients.find(c => c.id === p.client_id);
                  const statusColors = { draft: G, sent: BL, won: GR, lost: RD };
                  return (
                    <tr key={p.id} style={{ background: D2 }} onMouseEnter={e => e.currentTarget.style.background = D3} onMouseLeave={e => e.currentTarget.style.background = D2}>
                      <td style={tableCellS}><div style={{ fontWeight: 600 }}>{cl?.name || p.client_name || "Unknown"}</div></td>
                      <td style={tableCellS}>Tier {p.tier}</td>
                      <td style={{ ...tableCellS, fontWeight: 600 }}>${(p.total_low || 0).toLocaleString()} – ${(p.total_high || 0).toLocaleString()}</td>
                      <td style={{ ...tableCellS, color: G }}>{new Date(p.created_at).toLocaleDateString()}</td>
                      <td style={tableCellS}><span style={badgeS(statusColors[p.status] || G)}>{p.status}</span></td>
                      <td style={{ ...tableCellS, textAlign: "right" }}>
                        <select style={{ ...inputS, width: "auto", padding: "4px 8px", fontSize: 11 }} value={p.status} onChange={e => updateStatus(p.id, e.target.value)}>
                          {["draft", "sent", "won", "lost"].map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}
